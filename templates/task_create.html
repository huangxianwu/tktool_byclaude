{% extends "base.html" %}

{% block content %}
<!-- é¡µé¢å¤´éƒ¨ -->
<div class="mb-8">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">åˆ›å»ºä»»åŠ¡</h1>
            <p class="text-gray-600 mt-1">å·¥ä½œæµ: <span id="workflowName" class="font-medium text-primary"></span></p>
        </div>
        <button onclick="window.history.back()" 
                class="inline-flex items-center px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors duration-200">
            <i class="fas fa-arrow-left mr-2"></i>
            è¿”å›
        </button>
    </div>
</div>

<!-- åˆ›å»ºä»»åŠ¡è¡¨å• -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <form id="taskForm" class="space-y-6">
        <!-- åŠ¨æ€è¡¨å•å­—æ®µ -->
        <div id="formFields" class="space-y-4">
            <!-- è¡¨å•å­—æ®µå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- ä»»åŠ¡æè¿° -->
        <div>
            <label for="taskDescription" class="block text-sm font-medium text-gray-700 mb-2">
                ä»»åŠ¡æè¿° (å¯é€‰)
            </label>
            <div class="relative">
                <textarea id="taskDescription" 
                          name="task_description" 
                          placeholder="è¯·è¾“å…¥ä»»åŠ¡æè¿°ï¼Œç”¨äºåœ¨ä»»åŠ¡åˆ—è¡¨ä¸­åŒºåˆ†ä¸åŒä»»åŠ¡" 
                          rows="3" 
                          maxlength="500"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors duration-200 resize-none history-input" 
                          data-history-key="task_description"></textarea>
                <div class="history-dropdown hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-40 overflow-y-auto"></div>
            </div>
            <p class="text-sm text-gray-500 mt-1">æœ€å¤š500å­—ç¬¦ï¼Œç”¨äºä»»åŠ¡ç®¡ç†å’Œè¯†åˆ«</p>
        </div>
        
        <!-- Pluså®ä¾‹é€‰æ‹© -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-start space-x-3">
                <input type="checkbox" 
                       id="isPlusCheckbox" 
                       name="is_plus"
                       checked
                       class="mt-1 h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                <div class="flex-1">
                    <label for="isPlusCheckbox" class="text-sm font-medium text-gray-900 cursor-pointer">
                        æ˜¯å¦è¿è¡ŒPlus (48Gæ˜¾å­˜æœºå™¨)
                    </label>
                    <p class="text-sm text-gray-600 mt-1">é€‰ä¸­åå°†åœ¨é«˜æ€§èƒ½æœºå™¨ä¸Šæ‰§è¡Œä»»åŠ¡ï¼Œé€‚ç”¨äºå¤§å‹æ¨¡å‹å’Œå¤æ‚è®¡ç®—</p>
                </div>
            </div>
        </div>
        
        <!-- æäº¤æŒ‰é’® -->
        <div class="flex items-center justify-end space-x-3 pt-6 border-t border-gray-200">
            <button type="button" 
                    onclick="window.history.back()" 
                    class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                å–æ¶ˆ
            </button>
            <button type="button" id="create-only-btn"
                    class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors duration-200 font-medium">
                ä»…åˆ›å»º
            </button>
            <button type="button" id="create-and-start-btn"
                    class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 font-medium">
                åˆ›å»ºå¹¶å¯åŠ¨
            </button>
        </div>
    </form>
</div>

<style>
/* é¢„è§ˆå®¹å™¨ä¼˜åŒ– - å……åˆ†åˆ©ç”¨å¯ç”¨ç©ºé—´ï¼Œç§»é™¤æ‰€æœ‰ä¸å¿…è¦çš„æ ·å¼ */
.image-preview, .video-preview {
    width: 100%;
    margin: 0;
    padding: 0;
    height: auto;
}

/* é¢„è§ˆå®¹å™¨å†…éƒ¨div - ç®€åŒ–å¸ƒå±€ï¼Œè‡ªé€‚åº”å†…å®¹é«˜åº¦ï¼Œç§»é™¤å›ºå®šé«˜åº¦ */
.image-preview > div,
.video-preview > div {
    width: 100%;
    margin: 0;
    padding: 0;
    height: auto;
    /* ç§»é™¤ä»»ä½•å¯èƒ½çš„å›ºå®šé«˜åº¦æˆ–æœ€å°é«˜åº¦ */
}

/* è§†é¢‘é¢„è§ˆçš„ä¸­é—´å±‚å®¹å™¨ - ç§»é™¤æ‰€æœ‰å¯èƒ½å¯¼è‡´é¢å¤–é«˜åº¦çš„æ ·å¼ */
.video-preview .relative {
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
    box-shadow: none !important;
    background: transparent !important;
    height: auto;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

/* å†…éƒ¨å®¹å™¨ - å®Œå…¨è‡ªé€‚åº”å†…å®¹ï¼Œç§»é™¤æ‰€æœ‰å›ºå®šå°ºå¯¸ */
.image-preview .bg-gray-100,
.video-preview .bg-gray-900,
.video-preview .video-container {
    padding: 0;
    margin: 0;
    width: 100%;
    height: auto; /* ç¡®ä¿é«˜åº¦è‡ªé€‚åº” */
    min-height: 0; /* ç§»é™¤é»˜è®¤æœ€å°é«˜åº¦ */
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* ç¡®ä¿å›¾ç‰‡å’Œè§†é¢‘å……åˆ†åˆ©ç”¨å®¹å™¨ç©ºé—´ï¼Œå®Œå…¨è‡ªé€‚åº” */
.image-preview img,
.video-preview video {
    object-fit: contain;
    object-position: center;
    width: 100%;
    height: auto;
    max-height: 70vh;
    border-radius: 8px;
    display: block;
    /* ç§»é™¤ä»»ä½•å¯èƒ½å¯¼è‡´ç©ºç™½çš„æ ·å¼ */
}

/* æ‚¬åœæ•ˆæœä¼˜åŒ– */
.image-preview:hover .hover\:scale-105,
.video-preview:hover .hover\:scale-105 {
    transform: scale(1.02);
}

/* æ ‡ç­¾ä½ç½®è°ƒæ•´ */
.image-preview .absolute,
.video-preview .absolute {
    top: 8px;
    right: 8px;
}

/* å“åº”å¼ä¼˜åŒ– - ç§»åŠ¨è®¾å¤‡ä¸Šè¿›ä¸€æ­¥å‡å°‘ç©ºç™½ */
@media (max-width: 640px) {
    .image-preview img,
    .video-preview video {
        max-height: 60vh;
    }
    
    /* ç§»åŠ¨è®¾å¤‡ä¸Šç¡®ä¿å®¹å™¨å®Œå…¨è´´åˆå†…å®¹ */
    .image-preview > div,
    .video-preview > div {
        margin: 0;
        padding: 0;
    }
    
    .image-preview .bg-gray-100,
    .video-preview .bg-gray-900,
    .video-preview .video-container {
        margin: 0;
        padding: 0;
    }
}

/* å†å²è®°å½•ä¸‹æ‹‰æ¡†æ ·å¼ */
.history-dropdown {
    z-index: 1000;
}

.history-item {
    transition: background-color 0.15s ease;
}

.history-item:hover,
.history-item.active {
    background-color: #f3f4f6;
}

.history-item.active {
    background-color: #e5e7eb;
}
</style>

<script>
let workflowId = window.location.pathname.split('/').pop();
let workflow = null;
let autoStartNextSubmit = false;

// åŠ è½½å·¥ä½œæµè¯¦æƒ…
async function loadWorkflow() {
    try {
        const response = await fetch(`/api/workflows/${workflowId}`);
        workflow = await response.json();
        
        document.getElementById('workflowName').textContent = workflow.name;
        renderFormFields();
        
        // æ–°å¢ï¼šæ¸²æŸ“åå°è¯•æ ¹æ®URLä¸­çš„copyFromè¿›è¡Œé¢„å¡«
        await tryPrefillFromCopy();
    } catch (error) {
        console.error('åŠ è½½å·¥ä½œæµå¤±è´¥:', error);
    }
}

// æ¸²æŸ“è¡¨å•å­—æ®µ
function renderFormFields() {
    const container = document.getElementById('formFields');
    
    container.innerHTML = workflow.nodes.map(node => {
        let inputHtml = '';
        const inputClasses = 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors duration-200';
        
        switch(node.node_type) {
            case 'text':
                inputHtml = `
                    <div class="relative">
                        <input type="text" name="${node.node_id}" placeholder="è¯·è¾“å…¥${node.node_name}" required class="${inputClasses} history-input" data-history-key="text_${node.node_id}">
                        <div class="history-dropdown hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-40 overflow-y-auto"></div>
                    </div>
                `;
                break;
            case 'number':
                inputHtml = `<input type="number" name="${node.node_id}" placeholder="è¯·è¾“å…¥${node.node_name}" required class="${inputClasses}">`;
                break;
            case 'image':
                inputHtml = `
                    <div class="space-y-3">
                        <input type="file" name="${node.node_id}" accept="image/*" required 
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-primary file:text-white hover:file:bg-primary-dark transition-colors duration-200">
                        <div class="image-preview hidden" id="preview-${node.node_id}">
                            <div class="relative bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-300">
                                <div class="bg-gray-100 rounded-lg overflow-hidden">
                                    <img src="" alt="é¢„è§ˆå›¾" class="w-full h-auto object-contain transition-transform duration-300 hover:scale-105">
                                </div>
                                <div class="absolute top-2 right-2 bg-black bg-opacity-60 text-white px-2 py-1 rounded-md text-xs">
                                    <i class="fas fa-image mr-1"></i>å›¾ç‰‡é¢„è§ˆ
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                break;
            case 'video':
                inputHtml = `
                    <div class="space-y-3">
                        <input type="file" name="${node.node_id}" accept="video/*" required 
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-primary file:text-white hover:file:bg-primary-dark transition-colors duration-200">
                        <div class="video-preview hidden" id="preview-${node.node_id}">
                            <div class="relative bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-300">
                                <div class="bg-gray-900 rounded-lg overflow-hidden">
                                    <video controls preload="metadata" class="w-full h-auto object-contain rounded-lg">
                                        <source src="" type="video/mp4">
                                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                                    </video>
                                </div>
                                <div class="absolute top-2 right-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded-md text-xs">
                                    <i class="fas fa-video mr-1"></i>è§†é¢‘é¢„è§ˆ
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                break;
            case 'file':
                inputHtml = `
                    <div class="space-y-3">
                        <input type="file" name="${node.node_id}" accept="video/*" required 
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-primary file:text-white hover:file:bg-primary-dark transition-colors duration-200">
                        <div class="video-preview hidden" id="preview-${node.node_id}">
                            <div class="relative bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-300">
                                <div class="video-container bg-gray-900 rounded-lg overflow-hidden">
                                    <video controls preload="metadata" class="w-full h-full object-contain rounded-lg">
                                        <source src="" type="video/mp4">
                                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                                    </video>
                                </div>
                                <div class="absolute top-2 right-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded-md text-xs">
                                    <i class="fas fa-file-video mr-1"></i>æ–‡ä»¶é¢„è§ˆ
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                break;
            case 'audio':
                inputHtml = `
                    <div class="space-y-3">
                        <input type="file" name="${node.node_id}" accept="audio/*" required 
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-primary file:text-white hover:file:bg-primary-dark transition-colors duration-200">
                        <div class="audio-preview hidden" id="preview-${node.node_id}">
                            <div class="relative bg-white border border-gray-200 rounded-xl p-3 shadow-sm hover:shadow-md transition-all duration-300">
                                <div class="flex items-center space-x-4 p-4 bg-gradient-to-r from-purple-500 to-blue-500 rounded-lg">
                                    <div class="flex-shrink-0">
                                        <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center">
                                            <i class="fas fa-music text-white text-lg"></i>
                                        </div>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <audio controls preload="metadata" class="w-full">
                                            <source src="" type="audio/mpeg">
                                            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                                        </audio>
                                        <div class="mt-2 text-sm text-gray-600">
                                            <span class="audio-filename font-medium"></span>
                                            <span class="audio-size text-gray-500 ml-2"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="absolute top-2 right-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded-md text-xs">
                                    <i class="fas fa-music mr-1"></i>éŸ³é¢‘é¢„è§ˆ
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                break;
            case 'point_editor':
                inputHtml = `
                    <div class="space-y-3">
                        <button type="button" 
                                class="w-full px-4 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors duration-200 font-medium point-editor-btn"
                                data-node-id="${node.node_id}"
                                onclick="openPointEditor('${node.node_id}')">
                            <i class="fas fa-crosshairs mr-2"></i>
                            æ‰“å¼€ç‚¹ç¼–è¾‘å™¨
                        </button>
                        <div class="point-editor-result hidden" id="result-${node.node_id}">
                            <div class="bg-white border border-gray-200 rounded-lg p-4 space-y-3">
                                <div class="flex items-center justify-between">
                                    <h4 class="text-sm font-medium text-gray-700">
                                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                        ç‚¹ç¼–è¾‘å®Œæˆ
                                    </h4>
                                    <button type="button" 
                                            class="text-sm text-primary hover:text-primary-dark"
                                            onclick="openPointEditor('${node.node_id}')">
                                        é‡æ–°ç¼–è¾‘
                                    </button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <h5 class="text-xs font-medium text-gray-600 mb-2">åæ ‡å‚æ•°</h5>
                                        <div class="coordinates-display bg-gray-50 rounded p-2 text-xs font-mono"></div>
                                    </div>
                                    <div>
                                        <h5 class="text-xs font-medium text-gray-600 mb-2">æ ‡æ³¨å›¾ç‰‡</h5>
                                        <div class="annotated-image-preview">
                                            <img src="" alt="æ ‡æ³¨å›¾ç‰‡" class="w-full h-auto rounded border">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="${node.node_id}" class="point-editor-data">
                    </div>
                `;
                break;
        }
        
        const typeIcon = {
            'text': 'fas fa-font',
            'number': 'fas fa-hashtag', 
            'image': 'fas fa-image',
            'video': 'fas fa-video',
            'audio': 'fas fa-music',
            'point_editor': 'fas fa-crosshairs'
        }[node.node_type] || 'fas fa-circle';
        
        return `
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    <i class="${typeIcon} mr-2 text-primary"></i>
                    ${node.node_name}
                    <span class="text-xs text-gray-500 ml-2">(${node.node_type})</span>
                    <span class="text-red-500 ml-1">*</span>
                </label>
                ${inputHtml}
            </div>
        `;
    }).join('');
    
    // æ·»åŠ æ–‡ä»¶é¢„è§ˆåŠŸèƒ½
    addFilePreviewListeners();
    
    // æ·»åŠ å†å²è®°å½•åŠŸèƒ½
    addHistoryInputListeners();
}

// æ·»åŠ æ–‡ä»¶é¢„è§ˆç›‘å¬å™¨
function addFilePreviewListeners() {
    // å›¾ç‰‡é¢„è§ˆ
    document.querySelectorAll('input[type="file"][accept="image/*"]').forEach(input => {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const preview = document.getElementById(`preview-${this.name}`);
                const img = preview.querySelector('img');
                img.src = URL.createObjectURL(file);
                preview.classList.remove('hidden');
            }
        });
    });
    
    // è§†é¢‘é¢„è§ˆ
    document.querySelectorAll('input[type="file"][accept="video/*"]').forEach(input => {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const preview = document.getElementById(`preview-${this.name}`);
                const video = preview.querySelector('video');
                const source = preview.querySelector('video source');
                
                // åˆ›å»ºè§†é¢‘URL
                const videoUrl = URL.createObjectURL(file);
                source.src = videoUrl;
                video.load();
                
                // æ˜¾ç¤ºé¢„è§ˆ
                preview.classList.remove('hidden');
                
                // ç›‘å¬è§†é¢‘åŠ è½½å®Œæˆäº‹ä»¶ï¼Œè‡ªåŠ¨è°ƒæ•´é«˜åº¦
                video.addEventListener('loadedmetadata', function() {
                    const container = this.closest('.video-preview');
                    if (container) {
                        const aspectRatio = this.videoHeight / this.videoWidth;
                        const containerWidth = container.offsetWidth;
                        const calculatedHeight = containerWidth * aspectRatio;
                        
                        // è®¾ç½®æœ€å°é«˜åº¦250pxï¼Œæœ€å¤§é«˜åº¦500px
                        const finalHeight = Math.max(250, Math.min(500, calculatedHeight));
                        
                        // è®¾ç½®è§†é¢‘å…ƒç´ é«˜åº¦
                        this.style.height = finalHeight + 'px';
                        
                        // è°ƒæ•´è§†é¢‘ç›´æ¥å®¹å™¨(.bg-gray-900)
                        const videoContainer = this.closest('.bg-gray-900') || this.closest('.video-container');
                        if (videoContainer) {
                            videoContainer.style.height = finalHeight + 'px';
                            videoContainer.style.display = 'flex';
                            videoContainer.style.alignItems = 'center';
                            videoContainer.style.justifyContent = 'center';
                            videoContainer.style.padding = '0';
                            videoContainer.style.margin = '0';
                        }
                        
                        // è°ƒæ•´ä¸­é—´å±‚å®¹å™¨(.relative.bg-white...)
                        const middleContainer = container.querySelector('.relative');
                        if (middleContainer) {
                            middleContainer.style.height = finalHeight + 'px';
                            middleContainer.style.padding = '0';
                            middleContainer.style.margin = '0';
                            middleContainer.style.display = 'flex';
                            middleContainer.style.alignItems = 'center';
                            middleContainer.style.justifyContent = 'center';
                            middleContainer.style.overflow = 'hidden';
                        }
                        
                        // è°ƒæ•´æœ€å¤–å±‚é¢„è§ˆå®¹å™¨
                        container.style.height = finalHeight + 'px';
                        container.style.margin = '0';
                        container.style.padding = '0';
                        
                        // è‡ªåŠ¨æ’­æ”¾é¢„è§ˆï¼ˆé™éŸ³ï¼‰
                        this.muted = true;
                        this.play().catch(e => console.log('Auto-play prevented:', e));
                    }
                });
            }
        });
    });
    
    // éŸ³é¢‘é¢„è§ˆ
    document.querySelectorAll('input[type="file"][accept="audio/*"]').forEach(input => {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const preview = document.getElementById(`preview-${this.name}`);
                const audio = preview.querySelector('audio source');
                const filename = preview.querySelector('.audio-filename');
                const filesize = preview.querySelector('.audio-size');
                
                audio.src = URL.createObjectURL(file);
                preview.querySelector('audio').load();
                filename.textContent = file.name;
                filesize.textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                preview.classList.remove('hidden');
            }
        });
    });
}

// å†å²è®°å½•ç®¡ç†åŠŸèƒ½
class HistoryManager {
    constructor() {
        this.maxHistoryItems = 10;
    }
    
    // è·å–å†å²è®°å½•
    getHistory(key) {
        const history = localStorage.getItem(`history_${key}`);
        return history ? JSON.parse(history) : [];
    }
    
    // ä¿å­˜å†å²è®°å½•
    saveHistory(key, value) {
        if (!value || value.trim() === '') return;
        
        // æ¸…ç†æ–‡æœ¬ï¼šç§»é™¤å¤šä½™ç©ºæ ¼å’ŒæŠ˜è¡Œç¬¦
        let cleanValue = value.replace(/\s+/g, ' ').trim(); // å°†å¤šä¸ªç©ºæ ¼æ›¿æ¢ä¸ºå•ä¸ªç©ºæ ¼ï¼Œå¹¶å»é™¤é¦–å°¾ç©ºæ ¼
        cleanValue = cleanValue.replace(/[\r\n]+/g, ' '); // å°†æ¢è¡Œç¬¦æ›¿æ¢ä¸ºç©ºæ ¼
        
        if (!cleanValue || cleanValue === '') return;
        
        let history = this.getHistory(key);
        
        // ç§»é™¤é‡å¤é¡¹
        history = history.filter(item => item !== cleanValue);
        
        // æ·»åŠ åˆ°å¼€å¤´
        history.unshift(cleanValue);
        
        // é™åˆ¶æ•°é‡
        if (history.length > this.maxHistoryItems) {
            history = history.slice(0, this.maxHistoryItems);
        }
        
        localStorage.setItem(`history_${key}`, JSON.stringify(history));
    }
    
    // æ¨¡ç³ŠåŒ¹é…å†å²è®°å½•
    filterHistory(key, query) {
        const history = this.getHistory(key);
        if (!query) return history;
        
        return history.filter(item => 
            item.toLowerCase().includes(query.toLowerCase())
        );
    }
}

const historyManager = new HistoryManager();

// æ·»åŠ å†å²è®°å½•è¾“å…¥ç›‘å¬å™¨
function addHistoryInputListeners() {
    document.querySelectorAll('.history-input').forEach(input => {
        const historyKey = input.dataset.historyKey;
        const dropdown = input.parentElement.querySelector('.history-dropdown');
        
        // èšç„¦æ—¶æ˜¾ç¤ºå†å²è®°å½•
        input.addEventListener('focus', function() {
            showHistoryDropdown(this, dropdown, historyKey);
        });
        
        // è¾“å…¥æ—¶è¿‡æ»¤å†å²è®°å½•
        input.addEventListener('input', function() {
            showHistoryDropdown(this, dropdown, historyKey, this.value);
        });
        
        // å¤±ç„¦æ—¶éšè—ä¸‹æ‹‰æ¡†ï¼ˆå»¶è¿Ÿä»¥å…è®¸ç‚¹å‡»é€‰æ‹©ï¼‰
        input.addEventListener('blur', function() {
            setTimeout(() => {
                dropdown.classList.add('hidden');
            }, 200);
        });
        
        // é”®ç›˜å¯¼èˆª
        input.addEventListener('keydown', function(e) {
            const items = dropdown.querySelectorAll('.history-item');
            const activeItem = dropdown.querySelector('.history-item.active');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (activeItem) {
                    activeItem.classList.remove('active');
                    const next = activeItem.nextElementSibling;
                    if (next) {
                        next.classList.add('active');
                    } else {
                        items[0]?.classList.add('active');
                    }
                } else {
                    items[0]?.classList.add('active');
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (activeItem) {
                    activeItem.classList.remove('active');
                    const prev = activeItem.previousElementSibling;
                    if (prev) {
                        prev.classList.add('active');
                    } else {
                        items[items.length - 1]?.classList.add('active');
                    }
                } else {
                    items[items.length - 1]?.classList.add('active');
                }
            } else if (e.key === 'Enter' && activeItem) {
                e.preventDefault();
                this.value = activeItem.textContent;
                dropdown.classList.add('hidden');
            } else if (e.key === 'Escape') {
                dropdown.classList.add('hidden');
            }
        });
    });
}

// æ˜¾ç¤ºå†å²è®°å½•ä¸‹æ‹‰æ¡†
function showHistoryDropdown(input, dropdown, historyKey, query = '') {
    const history = historyManager.filterHistory(historyKey, query);
    
    if (history.length === 0) {
        dropdown.classList.add('hidden');
        return;
    }
    
    dropdown.innerHTML = history.map(item => `
        <div class="history-item px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm border-b border-gray-100 last:border-b-0" 
             onclick="selectHistoryItem(this, '${historyKey}')">
            ${escapeHtml(item)}
        </div>
    `).join('');
    
    dropdown.classList.remove('hidden');
}

// é€‰æ‹©å†å²è®°å½•é¡¹
function selectHistoryItem(element, historyKey) {
    const input = element.closest('.relative').querySelector('.history-input');
    const dropdown = element.closest('.history-dropdown');
    
    // æ¸…ç†æ–‡æœ¬ï¼šç§»é™¤å¤šä½™ç©ºæ ¼å’ŒæŠ˜è¡Œç¬¦
    let cleanText = element.textContent;
    cleanText = cleanText.replace(/\s+/g, ' ').trim(); // å°†å¤šä¸ªç©ºæ ¼æ›¿æ¢ä¸ºå•ä¸ªç©ºæ ¼ï¼Œå¹¶å»é™¤é¦–å°¾ç©ºæ ¼
    cleanText = cleanText.replace(/[\r\n]+/g, ' '); // å°†æ¢è¡Œç¬¦æ›¿æ¢ä¸ºç©ºæ ¼
    
    input.value = cleanText;
    dropdown.classList.add('hidden');
    input.focus();
}

// HTMLè½¬ä¹‰å‡½æ•°
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ä¿å­˜è¡¨å•å†å²è®°å½•
function saveFormHistory(formData) {
    // ä¿å­˜æ–‡æœ¬è¾“å…¥æ¡†çš„å†å²è®°å½•
    document.querySelectorAll('.history-input').forEach(input => {
        const historyKey = input.dataset.historyKey;
        const value = input.value;
        
        if (value && value.trim() !== '') {
            historyManager.saveHistory(historyKey, value.trim());
        }
    });
}

// æäº¤ä»»åŠ¡è¡¨å•
document.getElementById('taskForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const taskData = [];
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆæ ¹æ®ç‚¹å‡»çš„æŒ‰é’®å†³å®šï¼‰
    const createBtn = document.getElementById('create-only-btn');
    const createAndStartBtn = document.getElementById('create-and-start-btn');
    const originalCreateText = createBtn.textContent;
    const originalCreateStartText = createAndStartBtn.textContent;
    const workingBtn = autoStartNextSubmit ? createAndStartBtn : createBtn;
    workingBtn.textContent = 'å¤„ç†ä¸­...';
    createBtn.disabled = true;
    createAndStartBtn.disabled = true;

    // æ–°å¢ï¼šåœ¨è¿›å…¥å¼‚æ­¥é˜¶æ®µå‰ï¼Œæç¤ºâ€œä»»åŠ¡è½¬å…¥åå°â€
    let backgroundHintEl = null;
    try {
        backgroundHintEl = showInfoNotification('ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨è½¬å…¥åå°å¤„ç†...', { autoHideMs: 2000 });
    } catch (_) {
        // å¿½ç•¥é€šçŸ¥å¼‚å¸¸
    }
    
    try {
        // æ„å»ºä»»åŠ¡æ•°æ®ï¼ŒåŒ…å«æ–‡ä»¶çš„base64æ•°æ®
        for (const node of workflow.nodes) {
            const value = formData.get(node.node_id);
            let fieldValue = value;
            
            if (node.node_type === 'image' || node.node_type === 'video' || node.node_type === 'audio') {
                // æ–‡ä»¶ç±»å‹ï¼šè½¬æ¢ä¸ºbase64æ•°æ®URL
                if (value && value instanceof File) {
                    try {
                        fieldValue = await fileToBase64(value);
                    } catch (error) {
                        alert(`æ–‡ä»¶å¤„ç†å¤±è´¥: ${error.message}`);
                        // æ¢å¤æŒ‰é’®
                        createBtn.disabled = false;
                        createAndStartBtn.disabled = false;
                        createBtn.textContent = originalCreateText;
                        createAndStartBtn.textContent = originalCreateStartText;
                        return;
                    }
                }
            } else if (node.node_type === 'point_editor') {
                // ========================================
                // ğŸš€ ç‚¹ç¼–è¾‘å™¨å‚æ•°ä¼˜åŒ–æ–¹æ¡ˆ (v1.0)
                // ========================================
                // ğŸ“‹ èƒŒæ™¯é—®é¢˜ï¼š
                //   - æ—§æ¨¡å¼ï¼šä¼ é€’3ä¸ªå‚æ•° (points_store, coordinates, neg_coordinates)
                //   - é—®é¢˜ï¼šæ•°æ®å†—ä½™ï¼Œå†…å­˜æµªè´¹ï¼Œå¯¼è‡´torch.OutOfMemoryError
                //   - å½±å“ï¼šå¤§é‡åæ ‡æ•°æ®æ—¶ä»»åŠ¡å¤±è´¥
                //
                // ğŸ¯ ä¼˜åŒ–æ–¹æ¡ˆï¼š
                //   - æ–°æ¨¡å¼ï¼šä»…ä¼ é€’1ä¸ªå‚æ•° (points_store)
                //   - ä¼˜åŠ¿ï¼šåŒ…å«å®Œæ•´ä¿¡æ¯ï¼Œæ— æ•°æ®å†—ä½™ï¼Œå†…å­˜å‹å¥½
                //   - æ•ˆæœï¼šå‡å°‘47%æ•°æ®é‡ï¼Œé¿å…OOMé”™è¯¯
                //
                // ğŸ“Š æ€§èƒ½å¯¹æ¯”ï¼š
                //   - å‚æ•°æ•°é‡ï¼š3ä¸ª â†’ 1ä¸ª (å‡å°‘67%)
                //   - æ•°æ®å¤§å°ï¼š550å­—ç¬¦ â†’ 290å­—ç¬¦ (å‡å°‘47%)
                //   - å†…å­˜é£é™©ï¼šé«˜é£é™© â†’ ä½é£é™© (æ˜¾è‘—é™ä½)
                // ========================================
                
                if (value && value.trim() !== '') {
                    try {
                        const pointData = JSON.parse(value);
                        
                        // æå–æ­£è´Ÿæ ·æœ¬åæ ‡
                        const positiveCoords = pointData.coordinates?.positive || [];
                        const negativeCoords = pointData.coordinates?.negative || [];
                        
                        // ğŸ”§ æ ¸å¿ƒä¼˜åŒ–ï¼šæ„å»ºå•ä¸€çš„points_storeå‚æ•°
                        // åŒ…å«å®Œæ•´çš„æ­£è´Ÿåæ ‡ä¿¡æ¯ï¼Œæ›¿ä»£åŸæ¥çš„3å‚æ•°æ¨¡å¼
                        const pointsStoreData = {
                            positive: positiveCoords,  // æ­£æ ·æœ¬åæ ‡æ•°ç»„
                            negative: negativeCoords   // è´Ÿæ ·æœ¬åæ ‡æ•°ç»„
                        };
                        
                        console.log('âœ… ç‚¹ç¼–è¾‘å™¨æ•°æ®è½¬æ¢ (ä¼˜åŒ–å•å‚æ•°æ¨¡å¼):', {
                            åŸå§‹æ•°æ®: pointData,
                            points_store: pointsStoreData,
                            æ­£æ ·æœ¬æ•°é‡: positiveCoords.length,
                            è´Ÿæ ·æœ¬æ•°é‡: negativeCoords.length,
                            æ€»åæ ‡æ•°: positiveCoords.length + negativeCoords.length,
                            ä¼˜åŒ–è¯´æ˜: 'ä»…ä¼ é€’points_storeå‚æ•°ï¼Œé¿å…å†…å­˜å†—ä½™å¯¼è‡´çš„torch.OutOfMemoryError',
                            æ•°æ®å¤§å°: JSON.stringify(pointsStoreData).length + ' å­—ç¬¦'
                        });
                        
                        // éªŒè¯åæ ‡æ•°æ®æœ‰æ•ˆæ€§
                        if (positiveCoords.length === 0 && negativeCoords.length === 0) {
                            console.warn('âš ï¸ ç‚¹ç¼–è¾‘å™¨æ•°æ®ä¸ºç©ºï¼Œè·³è¿‡è¯¥èŠ‚ç‚¹');
                            continue;
                        }
                        
                        // ğŸ¯ å…³é”®ä¼˜åŒ–ï¼šåªä¼ é€’points_storeå‚æ•°
                        // æ—§æ¨¡å¼ä¼šé¢å¤–ä¼ é€’coordinateså’Œneg_coordinatesï¼Œé€ æˆæ•°æ®é‡å¤
                        // æ–°æ¨¡å¼points_storeå·²åŒ…å«æ‰€æœ‰å¿…è¦ä¿¡æ¯ï¼ŒComfyUIå¯æ­£ç¡®å¤„ç†
                        taskData.push({
                            node_id: node.node_id,
                            field_name: 'points_store',
                            field_value: JSON.stringify(pointsStoreData)
                        });
                        
                        console.log('ğŸš€ ä¼˜åŒ–ä¼ å‚æˆåŠŸ - å†…å­˜ä½¿ç”¨å‡å°‘ï¼Œé¿å…torch.OutOfMemoryError');
                        
                        // è·³è¿‡åé¢çš„å¸¸è§„å¤„ç†ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»æ‰‹åŠ¨æ·»åŠ äº†ä¼˜åŒ–åçš„å‚æ•°
                        continue;
                        
                    } catch (error) {
                        console.error('ç‚¹ç¼–è¾‘å™¨æ•°æ®æ ¼å¼è½¬æ¢å¤±è´¥:', error);
                        alert(`ç‚¹ç¼–è¾‘å™¨æ•°æ®æ ¼å¼é”™è¯¯: ${error.message}`);
                        // æ¢å¤æŒ‰é’®
                        createBtn.disabled = false;
                        createAndStartBtn.disabled = false;
                        createBtn.textContent = originalCreateText;
                        createAndStartBtn.textContent = originalCreateStartText;
                        return;
                    }
                }
            }
            
            // æ ¹æ®èŠ‚ç‚¹ç±»å‹è®¾ç½®æ­£ç¡®çš„fieldNameï¼ˆRunningHubæ ‡å‡†å­—æ®µåï¼‰
            let fieldName;
            switch(node.node_type) {
                case 'image':
                    fieldName = 'image';
                    break;
                case 'video':
                    fieldName = 'video';
                    break;
                case 'file':
                    fieldName = 'file';
                    break;
                case 'audio':
                    fieldName = 'audio';
                    break;
                case 'text':
                    fieldName = 'text';
                    break;
                case 'number':
                    fieldName = 'int';
                    break;
                // point_editor å·²åœ¨ä¸Šé¢ç‰¹æ®Šå¤„ç†ï¼Œç”Ÿæˆ3ä¸ªå‚æ•°
                default:
                    fieldName = node.node_type; // fallback to node_type
            }
            
            taskData.push({
                node_id: node.node_id,
                field_name: fieldName,
                field_value: fieldValue
            });
        }
        
        // è·å–Plusé€‰æ‹©çŠ¶æ€
        const isPlusChecked = document.getElementById('isPlusCheckbox').checked;
        
        // è·å–ä»»åŠ¡æè¿°
        const taskDescription = document.getElementById('taskDescription').value.trim();
        
        // åˆ›å»ºä»»åŠ¡ï¼ˆåç«¯å°†è‡ªåŠ¨å¤„ç†æ–‡ä»¶ä¸Šä¼ ï¼‰ï¼Œå¹¶æºå¸¦auto_start
        const response = await fetch('/api/tasks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                workflow_id: workflowId,
                data: taskData,
                is_plus: isPlusChecked,
                task_description: taskDescription,
                auto_start: autoStartNextSubmit
            })
        });
        
        if (response.ok) {
            const task = await response.json();
            
            // ä¿å­˜å†å²è®°å½•
            saveFormHistory(formData);
            
            // æˆåŠŸæç¤º + è‡ªåŠ¨åˆ·æ–°
            const extra = autoStartNextSubmit
                ? (task.auto_start_success ? 'ï¼ˆå·²æäº¤å¯åŠ¨ï¼‰' : `ï¼ˆå¯åŠ¨å¤±è´¥ï¼š${task.auto_start_message || 'åŸå› æœªçŸ¥'}ï¼‰`)
                : '';
            const refreshMs = 3000;
            showBackgroundSuccessNotification(`ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼ä»»åŠ¡ID: ${task.task_id} ${extra}ã€‚ä»»åŠ¡å·²è½¬å…¥åå°å¤„ç†ï¼Œé¡µé¢å°†åœ¨ ${(refreshMs/1000)} ç§’åè‡ªåŠ¨åˆ·æ–°ã€‚`, task.task_id, { autoRefreshMs: refreshMs });
            
            // é‡ç½®è¡¨å•
            document.getElementById('taskForm').reset();
            // é‡æ–°æ¸²æŸ“è¡¨å•å­—æ®µä»¥æ¸…ç©ºæ–‡ä»¶é¢„è§ˆ
            renderFormFields();
        } else {
            const error = await response.json();
            alert(`åˆ›å»ºä»»åŠ¡å¤±è´¥: ${error.error || 'æœªçŸ¥é”™è¯¯'}`);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('åˆ›å»ºä»»åŠ¡å¤±è´¥');
    } finally {
        // å¤ä½æŒ‰é’®
        autoStartNextSubmit = false;
        createBtn.disabled = false;
        createAndStartBtn.disabled = false;
        createBtn.textContent = originalCreateText;
        createAndStartBtn.textContent = originalCreateStartText;
        
        // éšè—â€œåå°å¤„ç†â€æç¤ºï¼ˆå¦‚æœè¿˜åœ¨ï¼‰
        if (backgroundHintEl && backgroundHintEl.parentElement) {
            try { backgroundHintEl.remove(); } catch (_) {}
        }
    }
});

// ä¿¡æ¯é€šçŸ¥ï¼ˆè½»é‡æç¤ºï¼‰
function showInfoNotification(message, { autoHideMs = 2500 } = {}) {
    const n = document.createElement('div');
    n.className = 'fixed top-4 right-4 z-50 bg-blue-500 text-white p-3 rounded-lg shadow-lg max-w-md transition-all duration-300 transform translate-x-full';
    n.innerHTML = `
        <div class="flex items-start space-x-3">
            <i class="fas fa-info-circle text-lg mt-0.5"></i>
            <div class="flex-1">
                <div class="font-medium">${message}</div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200 ml-2">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    document.body.appendChild(n);
    setTimeout(() => n.classList.remove('translate-x-full'), 50);
    if (autoHideMs > 0) {
        setTimeout(() => {
            n.classList.add('translate-x-full');
            setTimeout(() => { if (n.parentElement) n.remove(); }, 300);
        }, autoHideMs);
    }
    return n;
}

// æˆåŠŸé€šçŸ¥ï¼ˆå¸¦è‡ªåŠ¨åˆ·æ–°ä¸å–æ¶ˆï¼‰
function showBackgroundSuccessNotification(message, taskId, { autoRefreshMs = 3000 } = {}) {
    const wrap = document.createElement('div');
    wrap.className = 'fixed top-4 right-4 z-50 bg-green-500 text-white p-4 rounded-lg shadow-lg max-w-md transition-all duration-300 transform translate-x-full';

    let refreshTimer = null;
    const refreshCountdownSeconds = Math.max(1, Math.round(autoRefreshMs / 1000));
    let secondsLeft = refreshCountdownSeconds;

    wrap.innerHTML = `
        <div class="flex items-start space-x-3">
            <i class="fas fa-check-circle text-xl mt-0.5"></i>
            <div class="flex-1">
                <div class="font-medium">
                    ${message}
                </div>
                <div id="refresh-hint" class="text-sm text-white text-opacity-90 mt-1">
                    å³å°†åˆ·æ–°ï¼ˆ${secondsLeft}sï¼‰
                </div>
                <div class="mt-2 flex flex-wrap gap-2">
                    <button onclick="window.location.href='/tasks/${taskId}'" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded text-sm transition-colors duration-200">
                        æŸ¥çœ‹ä»»åŠ¡
                    </button>
                    <button id="cancel-refresh" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded text-sm transition-colors duration-200">
                        å–æ¶ˆè‡ªåŠ¨åˆ·æ–°
                    </button>
                    <button onclick="this.closest('.fixed').remove()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded text-sm transition-colors duration-200">
                        å…³é—­
                    </button>
                </div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200 ml-2">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;

    document.body.appendChild(wrap);
    setTimeout(() => wrap.classList.remove('translate-x-full'), 50);

    // å€’è®¡æ—¶ä¸è‡ªåŠ¨åˆ·æ–°
    const hintEl = wrap.querySelector('#refresh-hint');
    const tick = () => {
        secondsLeft -= 1;
        if (hintEl) hintEl.textContent = `å³å°†åˆ·æ–°ï¼ˆ${Math.max(0, secondsLeft)}sï¼‰`;
        if (secondsLeft <= 0) return;
        refreshTimer = setTimeout(tick, 1000);
    };
    refreshTimer = setTimeout(() => {
        // æœ€ç»ˆè§¦å‘åˆ·æ–°
        try { window.location.reload(); } catch (_) {}
    }, autoRefreshMs);

    // å¯åŠ¨å€’è®¡æ—¶æ˜¾ç¤ºï¼ˆä¸ä¸Šé¢åˆ·æ–°è®¡æ—¶å¹¶è¡Œï¼‰
    setTimeout(tick, 1000);

    // å–æ¶ˆåˆ·æ–°
    const cancelBtn = wrap.querySelector('#cancel-refresh');
    if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
            try { if (refreshTimer) clearTimeout(refreshTimer); } catch (_) {}
            if (hintEl) hintEl.textContent = 'å·²å–æ¶ˆè‡ªåŠ¨åˆ·æ–°';
            cancelBtn.disabled = true;
            cancelBtn.textContent = 'å·²å–æ¶ˆ';
        });
    }

    // è‡ªåŠ¨éšè—ï¼ˆä¸å¼ºåˆ¶ï¼‰
    setTimeout(() => {
        wrap.classList.add('translate-x-full');
        setTimeout(() => { if (wrap.parentElement) wrap.remove(); }, 300);
    }, autoRefreshMs + 8000);

    return wrap;
}

// æ–‡ä»¶è½¬base64å‡½æ•°
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

// æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
function showSuccessNotification(message, taskId) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 z-50 bg-green-500 text-white p-4 rounded-lg shadow-lg max-w-md transition-all duration-300 transform translate-x-full';
    
    notification.innerHTML = `
        <div class="flex items-start space-x-3">
            <i class="fas fa-check-circle text-xl mt-0.5"></i>
            <div class="flex-1">
                <div class="font-medium">${message}</div>
                <div class="mt-2 flex space-x-2">
                    <button onclick="window.location.href='/tasks/${taskId}'" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded text-sm transition-colors duration-200">
                        æŸ¥çœ‹ä»»åŠ¡
                    </button>
                    <button onclick="this.closest('.fixed').remove()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded text-sm transition-colors duration-200">
                        å…³é—­
                    </button>
                </div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200 ml-2">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // æ˜¾ç¤ºåŠ¨ç”»
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // è‡ªåŠ¨éšè—
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 300);
    }, 8000);
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', loadWorkflow);

// æ–°å¢ï¼šç»‘å®šâ€œä»…åˆ›å»º/åˆ›å»ºå¹¶å¯åŠ¨â€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('taskForm');
    const createOnlyBtn = document.getElementById('create-only-btn');
    const createAndStartBtn = document.getElementById('create-and-start-btn');

    if (form && createOnlyBtn && createAndStartBtn) {
        createOnlyBtn.addEventListener('click', () => {
            autoStartNextSubmit = false;
            form.requestSubmit();
        });

        createAndStartBtn.addEventListener('click', () => {
            autoStartNextSubmit = true;
            form.requestSubmit();
        });
    }
});

// æ–°å¢ï¼šæ ¹æ®URLå‚æ•°copyFromé¢„å¡«è¡¨å•
async function tryPrefillFromCopy() {
    try {
        const params = new URLSearchParams(window.location.search);
        const copyFromTaskId = params.get('copyFrom');
        if (!copyFromTaskId) return;
        
        await prefillFromTask(copyFromTaskId);
        showInfoNotification(`å·²ä»ä»»åŠ¡ ${copyFromTaskId} é¢„å¡«è¡¨å•ï¼Œå¯ç›´æ¥æäº¤æˆ–è°ƒæ•´åæäº¤ã€‚`, { autoHideMs: 3000 });
    } catch (e) {
        console.warn('é¢„å¡«å¤±è´¥:', e);
    }
}

async function prefillFromTask(taskId) {
    const resp = await fetch(`/api/tasks/${taskId}`);
    if (!resp.ok) {
        console.warn('è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥ï¼Œæ— æ³•é¢„å¡«');
        return;
    }
    const task = await resp.json();
    if (!task || !task.data || !Array.isArray(task.data)) return;

    // æ ¡éªŒworkflowåŒ¹é…ï¼ˆé˜²å¾¡æ€§åˆ¤æ–­ï¼‰
    if (String(task.workflow_id) !== String(workflowId)) {
        console.warn('ä»»åŠ¡ä¸å½“å‰å·¥ä½œæµä¸ä¸€è‡´ï¼Œè·³è¿‡é¢„å¡«');
        return;
    }

    // é¢„å¡«ä»»åŠ¡æè¿°å’ŒPluså‹¾é€‰
    try {
        if (typeof task.task_description === 'string') {
            const descEl = document.getElementById('taskDescription');
            if (descEl) descEl.value = task.task_description;
        }
        const plusEl = document.getElementById('isPlusCheckbox');
        if (plusEl && typeof task.is_plus !== 'undefined') {
            plusEl.checked = !!task.is_plus;
        }
    } catch (_) {}

    // å°†workflowèŠ‚ç‚¹æ˜ å°„ï¼Œä¾¿äºæŒ‰node_idæŸ¥è¯¢ç±»å‹
    const nodeTypeMap = new Map();
    try {
        (workflow.nodes || []).forEach(n => nodeTypeMap.set(String(n.node_id), n.node_type));
    } catch (_) {}

    // éå†ä»»åŠ¡æ•°æ®è¿›è¡Œé¢„å¡«
    for (const item of task.data) {
        const nodeId = String(item.node_id);
        const fieldValue = item.field_value;
        const nodeType = nodeTypeMap.get(nodeId);
        if (!nodeType) continue;

        const inputEl = document.querySelector(`[name="${CSS.escape(nodeId)}"]`);
        if (!inputEl) continue;

        try {
            if (nodeType === 'text') {
                if (typeof fieldValue === 'string') inputEl.value = fieldValue;
            } else if (nodeType === 'number') {
                const num = Number(fieldValue);
                if (!Number.isNaN(num)) inputEl.value = String(num);
            } else if (nodeType === 'image' || nodeType === 'video' || nodeType === 'audio') {
                // å°è¯•å°†dataURL(base64)å›å¡«åˆ°<input type="file">
                if (typeof fieldValue === 'string' && fieldValue.startsWith('data:')) {
                    try {
                        const filename = `${taskId}_${nodeId}.${guessExtensionFromDataUrl(fieldValue)}`;
                        const file = await dataUrlToFile(fieldValue, filename);
                        await setFileInputFromFile(inputEl, file);
                        // è§¦å‘changeä»¥åˆ·æ–°é¢„è§ˆ
                        inputEl.dispatchEvent(new Event('change', { bubbles: true }));
                    } catch (err) {
                        console.warn('æ–‡ä»¶é¢„å¡«å¤±è´¥ï¼ˆå¯èƒ½è¿‡å¤§æˆ–æµè§ˆå™¨é™åˆ¶ï¼‰ï¼š', err);
                        addInlineHint(inputEl, 'å·²åŠ è½½å†å²æ–‡ä»¶å†…å®¹ï¼Œä½†æµè§ˆå™¨é™åˆ¶æ— æ³•è‡ªåŠ¨å›å¡«åˆ°æ–‡ä»¶é€‰æ‹©å™¨ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡ä»¶');
                    }
                } else {
                    // æ— æ³•è‡ªåŠ¨å¡«å……ï¼Œç»™å‡ºæç¤º
                    addInlineHint(inputEl, 'æ— æ³•è‡ªåŠ¨å›å¡«å†å²æ–‡ä»¶ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©');
                }
            }
        } catch (err) {
            console.warn('å­—æ®µé¢„å¡«å¼‚å¸¸:', err);
        }
    }
}

// å°†dataURLè½¬æ¢ä¸ºFile
async function dataUrlToFile(dataUrl, filename) {
    const res = await fetch(dataUrl);
    const blob = await res.blob();
    return new File([blob], filename || 'file', { type: blob.type || 'application/octet-stream' });
}

// çŒœæµ‹æ‰©å±•å
function guessExtensionFromDataUrl(dataUrl) {
    try {
        const m = dataUrl.match(/^data:([^;]+);/);
        if (!m) return 'bin';
        const mime = m[1];
        if (mime.includes('png')) return 'png';
        if (mime.includes('jpeg') || mime.includes('jpg')) return 'jpg';
        if (mime.includes('gif')) return 'gif';
        if (mime.includes('mp4')) return 'mp4';
        if (mime.includes('webm')) return 'webm';
        if (mime.includes('mp3')) return 'mp3';
        if (mime.includes('wav')) return 'wav';
        return 'bin';
    } catch { return 'bin'; }
}

// å°†Fileè®¾ç½®åˆ°<input type="file">
async function setFileInputFromFile(inputEl, file) {
    const dt = new DataTransfer();
    dt.items.add(file);
    inputEl.files = dt.files;
}

// åœ¨æ–‡ä»¶è¾“å…¥ä¸‹é¢æ·»åŠ è½»æç¤º
function addInlineHint(inputEl, text) {
    try {
        const hint = document.createElement('div');
        hint.className = 'mt-2 text-xs text-gray-500';
        hint.textContent = text;
        const parent = inputEl.closest('.space-y-3') || inputEl.parentElement || inputEl;
        parent.appendChild(hint);
    } catch (_) {}
}

// ç‚¹ç¼–è¾‘å™¨ç›¸å…³å‡½æ•°
let currentNodeId = null;

function openPointEditor(nodeId) {
    currentNodeId = nodeId;
    const drawer = document.getElementById('point-editor-drawer');
    const iframe = document.getElementById('point-editor-iframe');
    
    // è®¾ç½®iframeæº
    iframe.src = '/point-editor?embedded=true&nodeId=' + nodeId;
    
    // æ˜¾ç¤ºä¾§æ‹‰çª—
    drawer.classList.remove('hidden');
    setTimeout(() => {
        drawer.classList.add('show');
    }, 10);
    
    // ç¦ç”¨é¡µé¢æ»šåŠ¨
    document.body.style.overflow = 'hidden';
}

function closePointEditor() {
    const drawer = document.getElementById('point-editor-drawer');
    drawer.classList.remove('show');
    
    setTimeout(() => {
        drawer.classList.add('hidden');
        const iframe = document.getElementById('point-editor-iframe');
        iframe.src = 'about:blank';
    }, 300);
    
    // æ¢å¤é¡µé¢æ»šåŠ¨
    document.body.style.overflow = '';
    currentNodeId = null;
}

// ç›‘å¬æ¥è‡ªiframeçš„æ¶ˆæ¯
window.addEventListener('message', function(event) {
    if (event.origin !== window.location.origin) return;
    
    if (event.data.type === 'pointEditorSave' && currentNodeId) {
        const data = event.data.data;
        
        // æ›´æ–°éšè—è¾“å…¥å­—æ®µ
        const hiddenInput = document.querySelector(`input[name="${currentNodeId}"]`);
        if (hiddenInput) {
            hiddenInput.value = JSON.stringify(data);
        }
        
        // æ˜¾ç¤ºç»“æœåŒºåŸŸ
        const resultDiv = document.getElementById(`result-${currentNodeId}`);
        if (resultDiv) {
            resultDiv.classList.remove('hidden');
            
            // æ›´æ–°åæ ‡æ˜¾ç¤º
            const coordsDisplay = resultDiv.querySelector('.coordinates-display');
            if (coordsDisplay && data.coordinates) {
                let coordsText = '';
                if (data.coordinates.positive && data.coordinates.positive.length > 0) {
                    coordsText += 'æ­£æ ·æœ¬: ' + data.coordinates.positive.map(p => `(${p.x}, ${p.y})`).join(', ') + '\n';
                }
                if (data.coordinates.negative && data.coordinates.negative.length > 0) {
                    coordsText += 'è´Ÿæ ·æœ¬: ' + data.coordinates.negative.map(p => `(${p.x}, ${p.y})`).join(', ');
                }
                coordsDisplay.textContent = coordsText || 'æš‚æ— åæ ‡æ•°æ®';
            }
            
            // æ›´æ–°å›¾ç‰‡é¢„è§ˆ
            const imagePreview = resultDiv.querySelector('.annotated-image-preview img');
            if (imagePreview && data.annotatedImage) {
                imagePreview.src = data.annotatedImage;
            }
        }
        
        // å…³é—­ä¾§æ‹‰çª—
        closePointEditor();
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        showToast('ç‚¹ç¼–è¾‘å™¨æ•°æ®å·²ä¿å­˜', 'success');
    }
});

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
    }`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>

<!-- ç‚¹ç¼–è¾‘å™¨ä¾§æ‹‰çª— -->
<div id="point-editor-drawer" class="fixed inset-0 z-50 hidden">
    <!-- èƒŒæ™¯é®ç½© -->
    <div class="absolute inset-0 bg-black bg-opacity-50 transition-opacity duration-300" onclick="closePointEditor()"></div>
    
    <!-- ä¾§æ‹‰çª—å†…å®¹ -->
    <div class="absolute right-0 top-0 h-full w-full max-w-7xl bg-white shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out drawer-content">
        <!-- å¤´éƒ¨ -->
        <div class="flex items-center justify-between p-4 border-b border-gray-200 bg-gray-50">
            <h3 class="text-lg font-medium text-gray-900">
                <i class="fas fa-crosshairs mr-2 text-primary"></i>
                ç‚¹ç¼–è¾‘å™¨
            </h3>
            <button type="button" 
                    class="text-gray-400 hover:text-gray-600 transition-colors"
                    onclick="closePointEditor()">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <!-- iframeå†…å®¹ -->
        <div class="h-full pb-16">
            <iframe id="point-editor-iframe" 
                    src="about:blank" 
                    class="w-full h-full border-0"
                    frameborder="0">
            </iframe>
        </div>
    </div>
</div>

<style>
#point-editor-drawer.show .drawer-content {
    transform: translateX(0);
}

#point-editor-drawer.show {
    backdrop-filter: blur(2px);
}

.drawer-content {
    max-height: 100vh;
    overflow: hidden;
}

@media (max-width: 768px) {
    #point-editor-drawer .drawer-content {
        max-width: 100%;
    }
}
</style>

{% endblock %}