{% extends "base.html" %}

{% block content %}
<!-- 页面头部 -->
<div class="mb-8">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">创建任务</h1>
            <p class="text-gray-600 mt-1">工作流: <span id="workflowName" class="font-medium text-primary"></span></p>
        </div>
        <button onclick="window.history.back()" 
                class="inline-flex items-center px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors duration-200">
            <i class="fas fa-arrow-left mr-2"></i>
            返回
        </button>
    </div>
</div>

<!-- 创建任务表单 -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <form id="taskForm" class="space-y-6">
        <!-- 动态表单字段 -->
        <div id="formFields" class="space-y-4">
            <!-- 表单字段将通过JS动态生成 -->
        </div>
        
        <!-- 任务描述 -->
        <div>
            <label for="taskDescription" class="block text-sm font-medium text-gray-700 mb-2">
                任务描述 (可选)
            </label>
            <textarea id="taskDescription" 
                      name="task_description" 
                      placeholder="请输入任务描述，用于在任务列表中区分不同任务" 
                      rows="3" 
                      maxlength="500"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors duration-200 resize-none"></textarea>
            <p class="text-sm text-gray-500 mt-1">最多500字符，用于任务管理和识别</p>
        </div>
        
        <!-- Plus实例选择 -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-start space-x-3">
                <input type="checkbox" 
                       id="isPlusCheckbox" 
                       name="is_plus"
                       class="mt-1 h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                <div class="flex-1">
                    <label for="isPlusCheckbox" class="text-sm font-medium text-gray-900 cursor-pointer">
                        是否运行Plus (48G显存机器)
                    </label>
                    <p class="text-sm text-gray-600 mt-1">选中后将在高性能机器上执行任务，适用于大型模型和复杂计算</p>
                </div>
            </div>
        </div>
        
        <!-- 提交按钮 -->
        <div class="flex items-center justify-end space-x-3 pt-6 border-t border-gray-200">
            <button type="button" 
                    onclick="window.history.back()" 
                    class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                取消
            </button>
            <button type="submit" 
                    class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors duration-200 font-medium">
                创建任务
            </button>
        </div>
    </form>
</div>

<script>
let workflowId = window.location.pathname.split('/').pop();
let workflow = null;

// 加载工作流详情
async function loadWorkflow() {
    try {
        const response = await fetch(`/api/workflows/${workflowId}`);
        workflow = await response.json();
        
        document.getElementById('workflowName').textContent = workflow.name;
        renderFormFields();
    } catch (error) {
        console.error('加载工作流失败:', error);
    }
}

// 渲染表单字段
function renderFormFields() {
    const container = document.getElementById('formFields');
    
    container.innerHTML = workflow.nodes.map(node => {
        let inputHtml = '';
        const inputClasses = 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors duration-200';
        
        switch(node.node_type) {
            case 'text':
                inputHtml = `<input type="text" name="${node.node_id}" placeholder="请输入${node.node_name}" required class="${inputClasses}">`;
                break;
            case 'number':
                inputHtml = `<input type="number" name="${node.node_id}" placeholder="请输入${node.node_name}" required class="${inputClasses}">`;
                break;
            case 'image':
                inputHtml = `
                    <div class="space-y-3">
                        <input type="file" name="${node.node_id}" accept="image/*" required 
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-primary file:text-white hover:file:bg-primary-dark transition-colors duration-200">
                        <div class="image-preview hidden" id="preview-${node.node_id}">
                            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                <img src="" alt="预览图" class="max-w-full h-auto max-h-48 rounded-lg shadow-sm">
                            </div>
                        </div>
                    </div>
                `;
                break;
            case 'video':
                inputHtml = `
                    <div class="space-y-3">
                        <input type="file" name="${node.node_id}" accept="video/*" required 
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-primary file:text-white hover:file:bg-primary-dark transition-colors duration-200">
                        <div class="video-preview hidden" id="preview-${node.node_id}">
                            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                <video controls class="max-w-full h-auto max-h-48 rounded-lg shadow-sm">
                                    <source src="" type="video/mp4">
                                </video>
                            </div>
                        </div>
                    </div>
                `;
                break;
        }
        
        const typeIcon = {
            'text': 'fas fa-font',
            'number': 'fas fa-hashtag', 
            'image': 'fas fa-image',
            'video': 'fas fa-video'
        }[node.node_type] || 'fas fa-circle';
        
        return `
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    <i class="${typeIcon} mr-2 text-primary"></i>
                    ${node.node_name}
                    <span class="text-xs text-gray-500 ml-2">(${node.node_type})</span>
                    <span class="text-red-500 ml-1">*</span>
                </label>
                ${inputHtml}
            </div>
        `;
    }).join('');
    
    // 添加文件预览功能
    addFilePreviewListeners();
}

// 添加文件预览监听器
function addFilePreviewListeners() {
    // 图片预览
    document.querySelectorAll('input[type="file"][accept="image/*"]').forEach(input => {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const preview = document.getElementById(`preview-${this.name}`);
                const img = preview.querySelector('img');
                img.src = URL.createObjectURL(file);
                preview.classList.remove('hidden');
            }
        });
    });
    
    // 视频预览
    document.querySelectorAll('input[type="file"][accept="video/*"]').forEach(input => {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const preview = document.getElementById(`preview-${this.name}`);
                const video = preview.querySelector('video source');
                video.src = URL.createObjectURL(file);
                preview.querySelector('video').load();
                preview.classList.remove('hidden');
            }
        });
    });
}

// 提交任务表单
document.getElementById('taskForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const taskData = [];
    
    // 显示加载状态
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = '处理中...';
    submitBtn.disabled = true;
    
    try {
        // 构建任务数据，包含文件的base64数据
        for (const node of workflow.nodes) {
            const value = formData.get(node.node_id);
            let fieldValue = value;
            
            if (node.node_type === 'image' || node.node_type === 'video') {
                // 文件类型：转换为base64数据URL
                if (value && value instanceof File) {
                    try {
                        fieldValue = await fileToBase64(value);
                    } catch (error) {
                        alert(`文件处理失败: ${error.message}`);
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        return;
                    }
                }
            }
            
            // 根据节点类型设置正确的fieldName（RunningHub标准字段名）
            let fieldName;
            switch(node.node_type) {
                case 'image':
                    fieldName = 'image';
                    break;
                case 'video':
                    fieldName = 'video';
                    break;
                case 'text':
                    fieldName = 'text';
                    break;
                case 'number':
                    fieldName = 'int';
                    break;
                default:
                    fieldName = node.node_type; // fallback to node_type
            }
            
            taskData.push({
                node_id: node.node_id,
                field_name: fieldName,
                field_value: fieldValue
            });
        }
        
        // 获取Plus选择状态
        const isPlusChecked = document.getElementById('isPlusCheckbox').checked;
        
        // 获取任务描述
        const taskDescription = document.getElementById('taskDescription').value.trim();
        
        // 创建任务（后端将自动处理文件上传）
        const response = await fetch('/api/tasks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                workflow_id: workflowId,
                data: taskData,
                is_plus: isPlusChecked,
                task_description: taskDescription
            })
        });
        
        if (response.ok) {
            const task = await response.json();
            alert('任务创建成功！');
            window.location.href = `/tasks/${task.task_id}`;
        } else {
            const error = await response.json();
            alert(`创建任务失败: ${error.error || '未知错误'}`);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('创建任务失败');
    } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
});

// 文件转base64函数
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', loadWorkflow);
</script>
{% endblock %}