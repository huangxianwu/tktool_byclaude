{% extends "base.html" %}

{% block content %}
<!-- 页面头部 -->
<div class="mb-8">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">创建任务</h1>
            <p class="text-gray-600 mt-1">工作流: <span id="workflowName" class="font-medium text-primary"></span></p>
        </div>
        <button onclick="window.history.back()" 
                class="inline-flex items-center px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors duration-200">
            <i class="fas fa-arrow-left mr-2"></i>
            返回
        </button>
    </div>
</div>

<!-- 创建任务表单 -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <form id="taskForm" class="space-y-6">
        <!-- 动态表单字段 -->
        <div id="formFields" class="space-y-4">
            <!-- 表单字段将通过JS动态生成 -->
        </div>
        
        <!-- 任务描述 -->
        <div>
            <label for="taskDescription" class="block text-sm font-medium text-gray-700 mb-2">
                任务描述 (可选)
            </label>
            <div class="relative">
                <textarea id="taskDescription" 
                          name="task_description" 
                          placeholder="请输入任务描述，用于在任务列表中区分不同任务" 
                          rows="3" 
                          maxlength="500"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors duration-200 resize-none history-input" 
                          data-history-key="task_description"></textarea>
                <div class="history-dropdown hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-40 overflow-y-auto"></div>
            </div>
            <p class="text-sm text-gray-500 mt-1">最多500字符，用于任务管理和识别</p>
        </div>
        
        <!-- Plus实例选择 -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-start space-x-3">
                <input type="checkbox" 
                       id="isPlusCheckbox" 
                       name="is_plus"
                       checked
                       class="mt-1 h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                <div class="flex-1">
                    <label for="isPlusCheckbox" class="text-sm font-medium text-gray-900 cursor-pointer">
                        是否运行Plus (48G显存机器)
                    </label>
                    <p class="text-sm text-gray-600 mt-1">选中后将在高性能机器上执行任务，适用于大型模型和复杂计算</p>
                </div>
            </div>
        </div>
        
        <!-- 提交按钮 -->
        <div class="flex items-center justify-end space-x-3 pt-6 border-t border-gray-200">
            <button type="button" 
                    onclick="window.history.back()" 
                    class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                取消
            </button>
            <button type="submit" 
                    class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors duration-200 font-medium">
                创建任务
            </button>
        </div>
    </form>
</div>

<style>
/* 自适应宽高比样式 */
.aspect-w-16 {
    position: relative;
    width: 100%;
}
.aspect-w-16.aspect-h-9 {
    padding-bottom: 56.25%; /* 16:9 = 9/16 = 0.5625 */
}
.aspect-w-16.aspect-h-9 > * {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

/* 预览容器优化 - 增大宽度，减少空白 */
.image-preview, .video-preview {
    max-width: 400px;
    margin: 0 auto;
}

/* 使用更灵活的宽高比设置 */
.image-preview .aspect-w-16.aspect-h-9,
.video-preview .aspect-w-16.aspect-h-9 {
    padding-bottom: 0; /* 移除固定宽高比 */
    height: auto;
    min-height: 200px;
    max-height: 300px;
}

/* 确保图片和视频在容器内完整显示，减少空白 */
.image-preview img,
.video-preview video {
    object-fit: contain; /* 保持完整画面，不裁剪 */
    object-position: center;
    width: 100%;
    height: auto;
    max-height: 300px;
    border-radius: 8px;
}

/* 悬停效果优化 */
.image-preview:hover .hover\:scale-105,
.video-preview:hover .hover\:scale-105 {
    transform: scale(1.02);
}

/* 响应式优化 */
@media (max-width: 640px) {
    .image-preview, .video-preview {
        max-width: 100%;
    }
    .image-preview .aspect-w-16.aspect-h-9,
    .video-preview .aspect-w-16.aspect-h-9 {
        min-height: 180px;
        max-height: 250px;
    }
    .image-preview img,
    .video-preview video {
        max-height: 250px;
    }
}

/* 历史记录下拉框样式 */
.history-dropdown {
    z-index: 1000;
}

.history-item {
    transition: background-color 0.15s ease;
}

.history-item:hover,
.history-item.active {
    background-color: #f3f4f6;
}

.history-item.active {
    background-color: #e5e7eb;
}
</style>

<script>
let workflowId = window.location.pathname.split('/').pop();
let workflow = null;

// 加载工作流详情
async function loadWorkflow() {
    try {
        const response = await fetch(`/api/workflows/${workflowId}`);
        workflow = await response.json();
        
        document.getElementById('workflowName').textContent = workflow.name;
        renderFormFields();
    } catch (error) {
        console.error('加载工作流失败:', error);
    }
}

// 渲染表单字段
function renderFormFields() {
    const container = document.getElementById('formFields');
    
    container.innerHTML = workflow.nodes.map(node => {
        let inputHtml = '';
        const inputClasses = 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors duration-200';
        
        switch(node.node_type) {
            case 'text':
                inputHtml = `
                    <div class="relative">
                        <input type="text" name="${node.node_id}" placeholder="请输入${node.node_name}" required class="${inputClasses} history-input" data-history-key="text_${node.node_id}">
                        <div class="history-dropdown hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-40 overflow-y-auto"></div>
                    </div>
                `;
                break;
            case 'number':
                inputHtml = `<input type="number" name="${node.node_id}" placeholder="请输入${node.node_name}" required class="${inputClasses}">`;
                break;
            case 'image':
                inputHtml = `
                    <div class="space-y-3">
                        <input type="file" name="${node.node_id}" accept="image/*" required 
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-primary file:text-white hover:file:bg-primary-dark transition-colors duration-200">
                        <div class="image-preview hidden" id="preview-${node.node_id}">
                            <div class="relative bg-white border border-gray-200 rounded-xl p-3 shadow-sm hover:shadow-md transition-all duration-300">
                                <div class="aspect-w-16 aspect-h-9 bg-gray-100 rounded-lg overflow-hidden">
                                    <img src="" alt="预览图" class="w-full h-full object-contain transition-transform duration-300 hover:scale-105">
                                </div>
                                <div class="absolute top-2 right-2 bg-black bg-opacity-60 text-white px-2 py-1 rounded-md text-xs">
                                    <i class="fas fa-image mr-1"></i>图片预览
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                break;
            case 'video':
                inputHtml = `
                    <div class="space-y-3">
                        <input type="file" name="${node.node_id}" accept="video/*" required 
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-primary file:text-white hover:file:bg-primary-dark transition-colors duration-200">
                        <div class="video-preview hidden" id="preview-${node.node_id}">
                            <div class="relative bg-white border border-gray-200 rounded-xl p-3 shadow-sm hover:shadow-md transition-all duration-300">
                                <div class="aspect-w-16 aspect-h-9 bg-gray-900 rounded-lg overflow-hidden">
                                    <video controls preload="metadata" class="w-full h-full object-contain rounded-lg">
                                        <source src="" type="video/mp4">
                                        您的浏览器不支持视频播放。
                                    </video>
                                </div>
                                <div class="absolute top-2 right-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded-md text-xs">
                                    <i class="fas fa-video mr-1"></i>视频预览
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                break;
            case 'audio':
                inputHtml = `
                    <div class="space-y-3">
                        <input type="file" name="${node.node_id}" accept="audio/*" required 
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-primary file:text-white hover:file:bg-primary-dark transition-colors duration-200">
                        <div class="audio-preview hidden" id="preview-${node.node_id}">
                            <div class="relative bg-white border border-gray-200 rounded-xl p-3 shadow-sm hover:shadow-md transition-all duration-300">
                                <div class="flex items-center space-x-4 p-4 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg">
                                    <div class="flex-shrink-0">
                                        <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center">
                                            <i class="fas fa-music text-white text-lg"></i>
                                        </div>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <audio controls preload="metadata" class="w-full">
                                            <source src="" type="audio/mpeg">
                                            您的浏览器不支持音频播放。
                                        </audio>
                                        <div class="mt-2 text-sm text-gray-600">
                                            <span class="audio-filename font-medium"></span>
                                            <span class="audio-size text-gray-500 ml-2"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="absolute top-2 right-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded-md text-xs">
                                    <i class="fas fa-music mr-1"></i>音频预览
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                break;
        }
        
        const typeIcon = {
            'text': 'fas fa-font',
            'number': 'fas fa-hashtag', 
            'image': 'fas fa-image',
            'video': 'fas fa-video',
            'audio': 'fas fa-music'
        }[node.node_type] || 'fas fa-circle';
        
        return `
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    <i class="${typeIcon} mr-2 text-primary"></i>
                    ${node.node_name}
                    <span class="text-xs text-gray-500 ml-2">(${node.node_type})</span>
                    <span class="text-red-500 ml-1">*</span>
                </label>
                ${inputHtml}
            </div>
        `;
    }).join('');
    
    // 添加文件预览功能
    addFilePreviewListeners();
    
    // 添加历史记录功能
    addHistoryInputListeners();
}

// 添加文件预览监听器
function addFilePreviewListeners() {
    // 图片预览
    document.querySelectorAll('input[type="file"][accept="image/*"]').forEach(input => {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const preview = document.getElementById(`preview-${this.name}`);
                const img = preview.querySelector('img');
                img.src = URL.createObjectURL(file);
                preview.classList.remove('hidden');
            }
        });
    });
    
    // 视频预览
    document.querySelectorAll('input[type="file"][accept="video/*"]').forEach(input => {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const preview = document.getElementById(`preview-${this.name}`);
                const video = preview.querySelector('video source');
                video.src = URL.createObjectURL(file);
                preview.querySelector('video').load();
                preview.classList.remove('hidden');
            }
        });
    });
    
    // 音频预览
    document.querySelectorAll('input[type="file"][accept="audio/*"]').forEach(input => {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const preview = document.getElementById(`preview-${this.name}`);
                const audio = preview.querySelector('audio source');
                const filename = preview.querySelector('.audio-filename');
                const filesize = preview.querySelector('.audio-size');
                
                audio.src = URL.createObjectURL(file);
                preview.querySelector('audio').load();
                filename.textContent = file.name;
                filesize.textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                preview.classList.remove('hidden');
            }
        });
    });
}

// 历史记录管理功能
class HistoryManager {
    constructor() {
        this.maxHistoryItems = 10;
    }
    
    // 获取历史记录
    getHistory(key) {
        const history = localStorage.getItem(`history_${key}`);
        return history ? JSON.parse(history) : [];
    }
    
    // 保存历史记录
    saveHistory(key, value) {
        if (!value || value.trim() === '') return;
        
        // 清理文本：移除多余空格和折行符
        let cleanValue = value.replace(/\s+/g, ' ').trim(); // 将多个空格替换为单个空格，并去除首尾空格
        cleanValue = cleanValue.replace(/[\r\n]+/g, ' '); // 将换行符替换为空格
        
        if (!cleanValue || cleanValue === '') return;
        
        let history = this.getHistory(key);
        
        // 移除重复项
        history = history.filter(item => item !== cleanValue);
        
        // 添加到开头
        history.unshift(cleanValue);
        
        // 限制数量
        if (history.length > this.maxHistoryItems) {
            history = history.slice(0, this.maxHistoryItems);
        }
        
        localStorage.setItem(`history_${key}`, JSON.stringify(history));
    }
    
    // 模糊匹配历史记录
    filterHistory(key, query) {
        const history = this.getHistory(key);
        if (!query) return history;
        
        return history.filter(item => 
            item.toLowerCase().includes(query.toLowerCase())
        );
    }
}

const historyManager = new HistoryManager();

// 添加历史记录输入监听器
function addHistoryInputListeners() {
    document.querySelectorAll('.history-input').forEach(input => {
        const historyKey = input.dataset.historyKey;
        const dropdown = input.parentElement.querySelector('.history-dropdown');
        
        // 聚焦时显示历史记录
        input.addEventListener('focus', function() {
            showHistoryDropdown(this, dropdown, historyKey);
        });
        
        // 输入时过滤历史记录
        input.addEventListener('input', function() {
            showHistoryDropdown(this, dropdown, historyKey, this.value);
        });
        
        // 失焦时隐藏下拉框（延迟以允许点击选择）
        input.addEventListener('blur', function() {
            setTimeout(() => {
                dropdown.classList.add('hidden');
            }, 200);
        });
        
        // 键盘导航
        input.addEventListener('keydown', function(e) {
            const items = dropdown.querySelectorAll('.history-item');
            const activeItem = dropdown.querySelector('.history-item.active');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (activeItem) {
                    activeItem.classList.remove('active');
                    const next = activeItem.nextElementSibling;
                    if (next) {
                        next.classList.add('active');
                    } else {
                        items[0]?.classList.add('active');
                    }
                } else {
                    items[0]?.classList.add('active');
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (activeItem) {
                    activeItem.classList.remove('active');
                    const prev = activeItem.previousElementSibling;
                    if (prev) {
                        prev.classList.add('active');
                    } else {
                        items[items.length - 1]?.classList.add('active');
                    }
                } else {
                    items[items.length - 1]?.classList.add('active');
                }
            } else if (e.key === 'Enter' && activeItem) {
                e.preventDefault();
                this.value = activeItem.textContent;
                dropdown.classList.add('hidden');
            } else if (e.key === 'Escape') {
                dropdown.classList.add('hidden');
            }
        });
    });
}

// 显示历史记录下拉框
function showHistoryDropdown(input, dropdown, historyKey, query = '') {
    const history = historyManager.filterHistory(historyKey, query);
    
    if (history.length === 0) {
        dropdown.classList.add('hidden');
        return;
    }
    
    dropdown.innerHTML = history.map(item => `
        <div class="history-item px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm border-b border-gray-100 last:border-b-0" 
             onclick="selectHistoryItem(this, '${historyKey}')">
            ${escapeHtml(item)}
        </div>
    `).join('');
    
    dropdown.classList.remove('hidden');
}

// 选择历史记录项
function selectHistoryItem(element, historyKey) {
    const input = element.closest('.relative').querySelector('.history-input');
    const dropdown = element.closest('.history-dropdown');
    
    // 清理文本：移除多余空格和折行符
    let cleanText = element.textContent;
    cleanText = cleanText.replace(/\s+/g, ' ').trim(); // 将多个空格替换为单个空格，并去除首尾空格
    cleanText = cleanText.replace(/[\r\n]+/g, ' '); // 将换行符替换为空格
    
    input.value = cleanText;
    dropdown.classList.add('hidden');
    input.focus();
}

// HTML转义函数
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// 保存表单历史记录
function saveFormHistory(formData) {
    // 保存文本输入框的历史记录
    document.querySelectorAll('.history-input').forEach(input => {
        const historyKey = input.dataset.historyKey;
        const value = input.value;
        
        if (value && value.trim() !== '') {
            historyManager.saveHistory(historyKey, value.trim());
        }
    });
}

// 提交任务表单
document.getElementById('taskForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const taskData = [];
    
    // 显示加载状态
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = '处理中...';
    submitBtn.disabled = true;
    
    try {
        // 构建任务数据，包含文件的base64数据
        for (const node of workflow.nodes) {
            const value = formData.get(node.node_id);
            let fieldValue = value;
            
            if (node.node_type === 'image' || node.node_type === 'video' || node.node_type === 'audio') {
                // 文件类型：转换为base64数据URL
                if (value && value instanceof File) {
                    try {
                        fieldValue = await fileToBase64(value);
                    } catch (error) {
                        alert(`文件处理失败: ${error.message}`);
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        return;
                    }
                }
            }
            
            // 根据节点类型设置正确的fieldName（RunningHub标准字段名）
            let fieldName;
            switch(node.node_type) {
                case 'image':
                    fieldName = 'image';
                    break;
                case 'video':
                    fieldName = 'video';
                    break;
                case 'audio':
                    fieldName = 'audio';
                    break;
                case 'text':
                    fieldName = 'text';
                    break;
                case 'number':
                    fieldName = 'int';
                    break;
                default:
                    fieldName = node.node_type; // fallback to node_type
            }
            
            taskData.push({
                node_id: node.node_id,
                field_name: fieldName,
                field_value: fieldValue
            });
        }
        
        // 获取Plus选择状态
        const isPlusChecked = document.getElementById('isPlusCheckbox').checked;
        
        // 获取任务描述
        const taskDescription = document.getElementById('taskDescription').value.trim();
        
        // 创建任务（后端将自动处理文件上传）
        const response = await fetch('/api/tasks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                workflow_id: workflowId,
                data: taskData,
                is_plus: isPlusChecked,
                task_description: taskDescription
            })
        });
        
        if (response.ok) {
            const task = await response.json();
            
            // 保存历史记录
            saveFormHistory(formData);
            
            showSuccessNotification(`任务创建成功！任务ID: ${task.task_id}`, task.task_id);
            // 重置表单
            document.getElementById('taskForm').reset();
            // 重新渲染表单字段以清空文件预览
            renderFormFields();
        } else {
            const error = await response.json();
            alert(`创建任务失败: ${error.error || '未知错误'}`);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('创建任务失败');
    } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
});

// 文件转base64函数
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

// 显示成功通知
function showSuccessNotification(message, taskId) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 z-50 bg-green-500 text-white p-4 rounded-lg shadow-lg max-w-md transition-all duration-300 transform translate-x-full';
    
    notification.innerHTML = `
        <div class="flex items-start space-x-3">
            <i class="fas fa-check-circle text-xl mt-0.5"></i>
            <div class="flex-1">
                <div class="font-medium">${message}</div>
                <div class="mt-2 flex space-x-2">
                    <button onclick="window.location.href='/tasks/${taskId}'" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded text-sm transition-colors duration-200">
                        查看任务
                    </button>
                    <button onclick="this.closest('.fixed').remove()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded text-sm transition-colors duration-200">
                        关闭
                    </button>
                </div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200 ml-2">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // 显示动画
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // 自动隐藏
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 300);
    }, 8000);
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', loadWorkflow);
</script>
{% endblock %}