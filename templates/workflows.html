{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h2>工作流模板管理</h2>
    <button onclick="createWorkflow()">新建工作流</button>
</div>

<div class="workflow-list" id="workflowList">
    <!-- 工作流列表将通过JS动态加载 -->
</div>

<!-- 新建工作流模态框 -->
<div id="createModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3>新建工作流</h3>
        <form id="workflowForm">
            <div class="form-group">
                <label>工作流ID (可选):</label>
                <input type="text" id="workflowId" placeholder="留空自动生成">
            </div>
            
            <div class="form-group">
                <label>工作流名称:</label>
                <input type="text" id="workflowName" required>
            </div>
            
            <div class="form-group">
                <label>节点配置:</label>
                <div id="nodesContainer">
                    <!-- 节点将通过JS动态添加 -->
                </div>
                <button type="button" onclick="addNode()">添加节点</button>
            </div>
            
            <button type="submit">创建</button>
        </form>
    </div>
</div>

<script>
// 加载工作流列表
async function loadWorkflows() {
    try {
        const response = await fetch('/api/workflows');
        const workflows = await response.json();
        
        const container = document.getElementById('workflowList');
        container.innerHTML = workflows.map(wf => `
            <div class="workflow-item">
                <h3>${wf.name}</h3>
                <p>ID: ${wf.workflow_id}</p>
                <p>创建时间: ${new Date(wf.created_at).toLocaleString()}</p>
                <p>节点数量: ${wf.nodes.length}</p>
                <div class="actions">
                    <button onclick="editWorkflow('${wf.workflow_id}')">编辑</button>
                    <button onclick="deleteWorkflow('${wf.workflow_id}')">删除</button>
                    <button onclick="createTask('${wf.workflow_id}')">创建任务</button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('加载工作流失败:', error);
    }
}

// 创建工作流
async function createWorkflow() {
    document.getElementById('createModal').style.display = 'block';
}

// 添加节点
function addNode() {
    const container = document.getElementById('nodesContainer');
    const nodeId = Date.now(); // 简单的时间戳作为临时ID
    
    // 创建新的节点元素
    const nodeDiv = document.createElement('div');
    nodeDiv.className = 'node-item';
    
    nodeDiv.innerHTML = `
        <input type="text" placeholder="节点ID (可选)" name="node_id">
        <input type="text" placeholder="节点名称" name="node_name" required>
        <select name="node_type" required>
            <option value="text">文本</option>
            <option value="number">数字</option>
            <option value="image">图片</option>
            <option value="video">视频</option>
        </select>
        <button type="button" onclick="this.parentElement.remove()">删除</button>
    `;
    
    // 使用appendChild而不是innerHTML来避免清空已有内容
    container.appendChild(nodeDiv);
}

// 提交工作流表单
document.getElementById('workflowForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const nodes = [];
    
    // 收集节点数据
    document.querySelectorAll('.node-item').forEach(node => {
        const nodeIdInput = node.querySelector('[name="node_id"]');
        const nodeData = {
            node_name: node.querySelector('[name="node_name"]').value,
            node_type: node.querySelector('[name="node_type"]').value
        };
        
        // 只有在用户输入了节点ID时才包含它
        if (nodeIdInput && nodeIdInput.value.trim()) {
            nodeData.node_id = nodeIdInput.value.trim();
        }
        
        nodes.push(nodeData);
    });
    
    const workflowId = document.getElementById('workflowId').value.trim();
    const workflowData = {
        name: document.getElementById('workflowName').value,
        nodes: nodes
    };
    
    // 只有在用户输入了workflow ID时才包含它
    if (workflowId) {
        workflowData.workflow_id = workflowId;
    }
    
    try {
        const response = await fetch('/api/workflows', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(workflowData)
        });
        
        if (response.ok) {
            closeModal();
            loadWorkflows();
        } else {
            alert('创建工作流失败');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('创建工作流失败');
    }
});

// 关闭模态框
function closeModal() {
    document.getElementById('createModal').style.display = 'none';
    document.getElementById('workflowForm').reset();
    document.getElementById('nodesContainer').innerHTML = '';
}

// 编辑工作流
function editWorkflow(workflowId) {
    window.location.href = `/workflows/edit/${workflowId}`;
}

// 删除工作流
async function deleteWorkflow(workflowId) {
    if (!confirm('确定要删除这个工作流吗？此操作不可恢复。')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/workflows/${workflowId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('删除成功');
            loadWorkflows(); // 重新加载列表
        } else {
            alert('删除失败');
        }
    } catch (error) {
        console.error('删除工作流失败:', error);
        alert('删除失败');
    }
}

// 创建任务
function createTask(workflowId) {
    window.location.href = `/tasks/create/${workflowId}`;
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', loadWorkflows);
</script>
{% endblock %}