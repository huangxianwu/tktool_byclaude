<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产出文件管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .primary { color: #3b82f6; }
        .bg-primary { background-color: #3b82f6; }
        .border-primary { border-color: #3b82f6; }
        
        /* 批量下载侧拉窗样式 */
        .batch-download-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
        }
        
        .batch-download-sidebar.active {
            transform: translateX(0);
        }
        
        .batch-download-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        
        .batch-download-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .download-item {
            border-bottom: 1px solid #e5e7eb;
            padding: 12px;
        }
        
        .download-item:last-child {
            border-bottom: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s ease;
        }
        
        .btn-pause, .btn-cancel {
            padding: 4px 8px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .btn-pause:hover {
            background: #f3f4f6;
        }
        
        .btn-cancel:hover {
            background: #fef2f2;
            color: #dc2626;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <!-- 页面标题 -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">产出文件管理</h1>
            <p class="text-gray-600">管理和下载工作流产出的文件</p>
        </div>

        <!-- 批量操作栏 -->
        <div id="batch-actions" class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
            <div class="flex items-center justify-between">
                <span class="text-blue-800 font-medium">
                    <i class="fas fa-check-square mr-2"></i>
                    已选择 <span id="selected-count">0</span> 个文件
                </span>
                <div class="space-x-2">
                    <button id="batch-download-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-download mr-2"></i>批量下载
                    </button>
                    <button id="clear-selection-btn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        <i class="fas fa-times mr-2"></i>清除选择
                    </button>
                </div>
            </div>
        </div>

        <!-- 筛选器 -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">工作流</label>
                    <select id="workflow-filter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">全部工作流</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">文件类型</label>
                    <select id="type-filter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">全部类型</option>
                        <option value="image">图片</option>
                        <option value="video">视频</option>
                        <option value="audio">音频</option>
                        <option value="text">文本</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">时间范围</label>
                    <select id="time-filter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">全部时间</option>
                        <option value="today">今天</option>
                        <option value="week">本周</option>
                        <option value="month">本月</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">排序</label>
                    <select id="sort-filter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="created_at_desc">创建时间 (新到旧)</option>
                        <option value="created_at_asc">创建时间 (旧到新)</option>
                        <option value="name_asc">文件名 (A-Z)</option>
                        <option value="name_desc">文件名 (Z-A)</option>
                        <option value="size_desc">文件大小 (大到小)</option>
                        <option value="size_asc">文件大小 (小到大)</option>
                    </select>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <div class="flex-1">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="搜索文件名..." 
                               class="w-full border border-gray-300 rounded-lg pl-10 pr-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                <button id="reset-filters" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                    <i class="fas fa-undo mr-2"></i>重置
                </button>
            </div>
        </div>

        <!-- 文件列表 -->
        <div id="outputs-container" class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div id="loading" class="flex items-center justify-center py-12">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <span class="ml-3 text-gray-600">加载中...</span>
            </div>
            
            <div id="outputs-grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 p-6">
                <!-- 文件卡片将通过JavaScript动态生成 -->
            </div>
            
            <div id="no-results" class="hidden text-center py-12">
                <i class="fas fa-folder-open text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600">暂无文件</p>
            </div>
        </div>

        <!-- 分页 -->
        <div id="pagination" class="hidden flex items-center justify-between mt-6">
            <div class="text-sm text-gray-700">
                显示第 <span id="page-start">1</span> - <span id="page-end">20</span> 项，共 <span id="total-items">0</span> 项
            </div>
            <div class="flex items-center space-x-2">
                <button id="prev-page" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span id="page-info" class="px-3 py-2 text-sm text-gray-700">第 1 页，共 1 页</span>
                <button id="next-page" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 批量下载侧拉窗 -->
    <div id="batch-download-overlay" class="batch-download-overlay" onclick="batchDownloadManager.close()"></div>
    <div id="batch-download-sidebar" class="batch-download-sidebar">
        <!-- 头部 -->
        <div class="flex items-center justify-between p-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">批量下载</h3>
            <button onclick="batchDownloadManager.close()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <!-- 下载统计 -->
        <div class="p-4 bg-gray-50 border-b border-gray-200">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-600">总进度</span>
                <span id="overall-progress-text" class="text-sm font-medium text-gray-900">0%</span>
            </div>
            <div class="progress-bar mb-3">
                <div id="overall-progress-fill" class="progress-fill" style="width: 0%"></div>
            </div>
            <div class="flex items-center justify-between text-xs text-gray-500">
                <span>文件: <span id="download-progress">0/0</span></span>
                <span>速度: <span id="download-speed">--</span></span>
            </div>
        </div>
        
        <!-- 下载列表 -->
        <div class="flex-1 overflow-y-auto">
            <div id="download-list">
                <!-- 下载项将通过JavaScript动态生成 -->
            </div>
        </div>
        
        <!-- 底部操作 -->
        <div class="p-4 border-t border-gray-200 bg-gray-50">
            <div class="flex space-x-2">
                <button onclick="batchDownloadManager.pauseAll()" class="flex-1 bg-yellow-500 text-white py-2 px-4 rounded-lg hover:bg-yellow-600 transition-colors">
                    <i class="fas fa-pause mr-2"></i>暂停全部
                </button>
                <button onclick="batchDownloadManager.cancelAll()" class="flex-1 bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">
                    <i class="fas fa-times mr-2"></i>取消全部
                </button>
            </div>
        </div>
    </div>

    <!-- 预览模态框 -->
    <div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-4xl max-h-[90vh] w-full mx-4 overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b border-gray-200">
                <h3 id="modal-title" class="text-lg font-semibold text-gray-900">文件预览</h3>
                <button onclick="closePreviewModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modal-content" class="p-4 max-h-96 overflow-auto">
                <!-- 预览内容将通过JavaScript动态加载 -->
            </div>
            <div class="flex items-center justify-end space-x-2 p-4 border-t border-gray-200">
                <button onclick="downloadCurrentFile()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-download mr-2"></i>下载
                </button>
                <button onclick="closePreviewModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                    关闭
                </button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let outputsManager;
        let batchDownloadManager;
        let currentPreviewFile = null;

        // 输出管理器类
        class OutputsManager {
            constructor() {
                this.outputs = [];
                this.filteredOutputs = [];
                this.currentPage = 1;
                this.pageSize = 20;
                this.totalPages = 1;
                this.filters = {
                    workflow: '',
                    type: '',
                    timeRange: '',
                    search: '',
                    sort: 'created_at_desc'
                };
            }

            async init() {
                await this.loadWorkflows();
                await this.loadOutputs();
                this.bindEvents();
            }

            bindEvents() {
                // 筛选器事件
                document.getElementById('workflow-filter').addEventListener('change', (e) => {
                    this.filters.workflow = e.target.value;
                    this.applyFilters();
                });
                
                document.getElementById('type-filter').addEventListener('change', (e) => {
                    this.filters.type = e.target.value;
                    this.applyFilters();
                });
                
                document.getElementById('time-filter').addEventListener('change', (e) => {
                    this.filters.timeRange = e.target.value;
                    this.applyFilters();
                });
                
                document.getElementById('sort-filter').addEventListener('change', (e) => {
                    this.filters.sort = e.target.value;
                    this.applyFilters();
                });
                
                // 搜索
                let searchTimeout;
                document.getElementById('search-input').addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        this.filters.search = e.target.value.trim();
                        this.applyFilters();
                    }, 300);
                });
                
                // 重置筛选
                document.getElementById('reset-filters').addEventListener('click', () => {
                    this.resetFilters();
                });
                
                // 分页事件
                document.getElementById('prev-page').addEventListener('click', () => {
                    if (this.currentPage > 1) {
                        this.currentPage--;
                        this.loadOutputs();
                    }
                });
                
                document.getElementById('next-page').addEventListener('click', () => {
                    if (this.currentPage < this.totalPages) {
                        this.currentPage++;
                        this.loadOutputs();
                    }
                });
                
                // 批量操作事件
                this.bindBatchEvents();
            }

            bindBatchEvents() {
                // 批量下载按钮
                document.getElementById('batch-download-btn').addEventListener('click', () => {
                    this.batchDownload();
                });
                
                // 清除选择按钮
                document.getElementById('clear-selection-btn').addEventListener('click', () => {
                    this.clearSelection();
                });
                
                // 监听选择框变化
                document.addEventListener('change', (e) => {
                    if (e.target.classList.contains('output-checkbox')) {
                        this.updateBatchActions();
                    }
                });
            }

            async loadWorkflows() {
                try {
                    const response = await fetch('/api/workflows');
                    const workflows = await response.json();
                    
                    const workflowFilter = document.getElementById('workflow-filter');
                    workflows.forEach(workflow => {
                        const option = document.createElement('option');
                        option.value = workflow.id;
                        option.textContent = workflow.name;
                        workflowFilter.appendChild(option);
                    });
                } catch (error) {
                    console.error('加载工作流失败:', error);
                }
            }

            async loadOutputs() {
                try {
                    document.getElementById('loading').classList.remove('hidden');
                    document.getElementById('outputs-grid').classList.add('hidden');
                    document.getElementById('no-results').classList.add('hidden');
                    
                    const params = new URLSearchParams({
                        page: this.currentPage,
                        page_size: this.pageSize,
                        ...this.filters
                    });
                    
                    const response = await fetch(`/api/outputs?${params}`);
                    const data = await response.json();
                    
                    this.outputs = data.outputs || [];
                    this.totalPages = data.total_pages || 1;
                    
                    this.renderOutputs();
                    this.updatePagination(data.total_items || 0);
                    
                } catch (error) {
                    console.error('加载产出文件失败:', error);
                    this.showError('加载产出文件失败');
                } finally {
                    document.getElementById('loading').classList.add('hidden');
                }
            }

            renderOutputs() {
                const container = document.getElementById('outputs-grid');
                const noResults = document.getElementById('no-results');
                
                if (this.outputs.length === 0) {
                    container.classList.add('hidden');
                    noResults.classList.remove('hidden');
                    return;
                }
                
                container.innerHTML = '';
                container.classList.remove('hidden');
                noResults.classList.add('hidden');
                
                this.outputs.forEach(output => {
                    const card = this.createOutputCard(output);
                    container.appendChild(card);
                });
            }

            createOutputCard(output) {
                const card = document.createElement('div');
                card.className = 'bg-white border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition-all duration-300 group';
                
                const fileType = this.getFileType(output.filename);
                const fileIcon = this.getFileIcon(fileType);
                
                card.innerHTML = `
                    <div class="relative">
                        <!-- 选择框 - 悬浮在左上角 -->
                        <div class="absolute top-3 left-3 z-10">
                            <input type="checkbox" class="output-checkbox w-4 h-4 text-blue-600 bg-white border-2 border-gray-300 rounded focus:ring-blue-500 focus:ring-2" 
                                   data-output='${JSON.stringify(output).replace(/'/g, "&apos;")}'>
                        </div>
                        
                        <!-- 文件类型标签 - 悬浮在右上角 -->
                        <div class="absolute top-3 right-3 z-10">
                            <div class="flex items-center space-x-1 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded-full">
                                <i class="${fileIcon}"></i>
                                <span>${fileType.toUpperCase()}</span>
                            </div>
                        </div>
                        
                        <!-- 文件预览区域 -->
                        <div class="relative cursor-pointer" onclick="previewFile('${output.file_path}', '${output.filename}', '${fileType}')">
                            ${this.renderFilePreview(output, fileType)}
                            
                            <!-- 悬浮操作按钮 - 只在hover时显示 -->
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-300 flex items-center justify-center opacity-0 group-hover:opacity-100">
                                <div class="flex items-center space-x-3">
                                    <button onclick="event.stopPropagation(); previewFile('${output.file_path}', '${output.filename}', '${fileType}')" 
                                            class="bg-white bg-opacity-90 hover:bg-opacity-100 text-gray-800 p-3 rounded-full shadow-lg transform hover:scale-110 transition-all duration-200"
                                            title="预览文件">
                                        <i class="fas fa-eye text-lg"></i>
                                    </button>
                                    <button onclick="event.stopPropagation(); downloadFile('${output.file_path}', '${output.filename}')" 
                                            class="bg-white bg-opacity-90 hover:bg-opacity-100 text-gray-800 p-3 rounded-full shadow-lg transform hover:scale-110 transition-all duration-200"
                                            title="下载文件">
                                        <i class="fas fa-download text-lg"></i>
                                    </button>
                                    ${fileType === 'video' ? `
                                    <button onclick="event.stopPropagation(); playVideoInCard(this, '${output.file_path}', '${output.filename}')" 
                                            class="bg-white bg-opacity-90 hover:bg-opacity-100 text-gray-800 p-3 rounded-full shadow-lg transform hover:scale-110 transition-all duration-200"
                                            title="在卡片中播放">
                                        <i class="fas fa-play text-lg"></i>
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <!-- 文件信息区域 -->
                        <div class="p-4">
                            <div class="space-y-2">
                                <h3 class="font-medium text-gray-900 text-sm truncate group-hover:text-blue-600 transition-colors" title="${output.filename}">
                                    ${output.filename}
                                </h3>
                                <div class="flex items-center justify-between text-xs text-gray-500">
                                    <span class="flex items-center space-x-1">
                                        <i class="fas fa-hdd text-xs"></i>
                                        <span>${this.formatFileSize(output.file_size || 0)}</span>
                                    </span>
                                    <span class="flex items-center space-x-1">
                                        <i class="fas fa-clock text-xs"></i>
                                        <span>${this.formatDate(output.created_at)}</span>
                                    </span>
                                </div>
                                <div class="text-xs text-gray-500 truncate flex items-center space-x-1" title="${output.workflow_name || '未知工作流'}">
                                    <i class="fas fa-project-diagram text-xs"></i>
                                    <span>${output.workflow_name || '未知工作流'}</span>
                                </div>
                            </div>
                            
                            <!-- 底部快速操作栏 -->
                            <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-100">
                                <div class="flex items-center space-x-2">
                                    <button onclick="previewFile('${output.file_path}', '${output.filename}', '${fileType}')" 
                                            class="text-blue-600 hover:text-blue-700 text-sm font-medium transition-colors">
                                        <i class="fas fa-eye mr-1"></i>预览
                                    </button>
                                    <span class="text-gray-300">|</span>
                                    <button onclick="downloadFile('${output.file_path}', '${output.filename}')" 
                                            class="text-green-600 hover:text-green-700 text-sm font-medium transition-colors">
                                        <i class="fas fa-download mr-1"></i>下载
                                    </button>
                                </div>
                                <div class="flex items-center space-x-1">
                                    ${this.renderQuickActions(output, fileType)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                return card;
            }

            renderQuickActions(output, fileType) {
                let actions = [];
                
                // 根据文件类型添加特定操作
                switch (fileType) {
                    case 'video':
                        actions.push(`
                            <button onclick="playVideoInCard(this, '${output.file_path}', '${output.filename}')" 
                                    class="text-purple-600 hover:text-purple-700 text-xs p-1 rounded hover:bg-purple-50 transition-colors"
                                    title="在卡片中播放">
                                <i class="fas fa-play"></i>
                            </button>
                        `);
                        break;
                    case 'audio':
                        actions.push(`
                            <button onclick="playAudioInCard(this, '${output.file_path}', '${output.filename}')" 
                                    class="text-orange-600 hover:text-orange-700 text-xs p-1 rounded hover:bg-orange-50 transition-colors"
                                    title="播放音频">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        `);
                        break;
                    case 'text':
                        actions.push(`
                            <button onclick="editTextFile('${output.file_path}', '${output.filename}')" 
                                    class="text-indigo-600 hover:text-indigo-700 text-xs p-1 rounded hover:bg-indigo-50 transition-colors"
                                    title="编辑文本">
                                <i class="fas fa-edit"></i>
                            </button>
                        `);
                        break;
                }
                
                // 添加分享按钮
                actions.push(`
                    <button onclick="shareFile('${output.file_path}', '${output.filename}')" 
                            class="text-gray-600 hover:text-gray-700 text-xs p-1 rounded hover:bg-gray-50 transition-colors"
                            title="分享文件">
                        <i class="fas fa-share-alt"></i>
                    </button>
                `);
                
                return actions.join('');
            }

            renderFilePreview(output, fileType) {
                const previewHeight = 'h-48';
                
                switch (fileType) {
                    case 'image':
                        return `
                            <div class="${previewHeight} bg-gray-100 rounded-t-lg overflow-hidden">
                                <img src="${output.file_path}" alt="${output.filename}" 
                                     class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" 
                                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIxIDNIMTBMMTAgMTNIMjFWM1oiIGZpbGw9IiNGM0Y0RjYiLz4KPHBhdGggZD0iTTMgMTFIMTRWMjFIM1YxMVoiIGZpbGw9IiNGM0Y0RjYiLz4KPC9zdmc+'; this.onerror=null;">
                            </div>
                        `;
                    case 'video':
                        return `
                            <div class="${previewHeight} bg-gray-900 rounded-t-lg flex items-center justify-center relative overflow-hidden">
                                <video class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" 
                                       preload="metadata" muted data-video-path="${output.file_path}">
                                    <source src="${output.file_path}#t=1" type="video/mp4">
                                </video>
                                <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-20">
                                    <div class="bg-white bg-opacity-80 rounded-full p-3">
                                        <i class="fas fa-play text-gray-800 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                        `;
                    case 'audio':
                        return `
                            <div class="${previewHeight} bg-gradient-to-br from-purple-400 to-pink-400 rounded-t-lg flex items-center justify-center">
                                <div class="text-center text-white">
                                    <i class="fas fa-music text-4xl mb-2"></i>
                                    <p class="text-sm font-medium">音频文件</p>
                                </div>
                            </div>
                        `;
                    case 'text':
                        return `
                            <div class="${previewHeight} bg-gradient-to-br from-blue-400 to-indigo-400 rounded-t-lg flex items-center justify-center">
                                <div class="text-center text-white">
                                    <i class="fas fa-file-text text-4xl mb-2"></i>
                                    <p class="text-sm font-medium">文本文件</p>
                                </div>
                            </div>
                        `;
                    default:
                        return `
                            <div class="${previewHeight} bg-gradient-to-br from-gray-400 to-gray-500 rounded-t-lg flex items-center justify-center">
                                <div class="text-center text-white">
                                    <i class="${this.getFileIcon(fileType)} text-4xl mb-2"></i>
                                    <p class="text-sm font-medium">${fileType.toUpperCase()} 文件</p>
                                </div>
                            </div>
                        `;
                }
            }

            getFileType(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(ext)) return 'image';
                if (['mp4', 'avi', 'mov', 'wmv', 'flv', 'mkv'].includes(ext)) return 'video';
                if (['mp3', 'wav', 'flac', 'aac', 'ogg'].includes(ext)) return 'audio';
                if (['txt', 'md', 'json', 'xml', 'csv', 'log'].includes(ext)) return 'text';
                if (['pdf'].includes(ext)) return 'pdf';
                if (['zip', 'rar', '7z', 'tar', 'gz'].includes(ext)) return 'archive';
                return 'other';
            }

            getFileIcon(fileType) {
                const icons = {
                    image: 'fas fa-image',
                    video: 'fas fa-video',
                    audio: 'fas fa-music',
                    text: 'fas fa-file-text',
                    pdf: 'fas fa-file-pdf',
                    archive: 'fas fa-file-archive',
                    other: 'fas fa-file'
                };
                return icons[fileType] || icons.other;
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            updateBatchActions() {
                const checkboxes = document.querySelectorAll('.output-checkbox:checked');
                const batchActions = document.getElementById('batch-actions');
                const selectedCount = document.getElementById('selected-count');
                
                selectedCount.textContent = checkboxes.length;
                
                if (checkboxes.length > 0) {
                    batchActions.classList.remove('hidden');
                } else {
                    batchActions.classList.add('hidden');
                }
            }

            clearSelection() {
                const checkboxes = document.querySelectorAll('.output-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                this.updateBatchActions();
            }

            async batchDownload() {
                const checkboxes = document.querySelectorAll('.output-checkbox:checked');
                if (checkboxes.length === 0) {
                    alert('请先选择要下载的文件');
                    return;
                }
                
                const selectedOutputs = Array.from(checkboxes).map(checkbox => {
                    return JSON.parse(checkbox.dataset.output.replace(/&apos;/g, "'"));
                });
                
                // 初始化批量下载管理器
                batchDownloadManager.totalFiles = selectedOutputs.length;
                batchDownloadManager.completedFiles = 0;
                batchDownloadManager.downloads.clear();
                
                // 打开侧拉窗
                batchDownloadManager.open();
                
                // 添加下载任务
                const downloadIds = [];
                selectedOutputs.forEach(output => {
                    const downloadId = batchDownloadManager.addDownload(output);
                    downloadIds.push(downloadId);
                });
                
                // 开始下载（添加延迟避免同时发起太多请求）
                for (let i = 0; i < downloadIds.length; i++) {
                    setTimeout(() => {
                        batchDownloadManager.startDownload(downloadIds[i]);
                    }, i * 200); // 每个下载间隔200ms
                }
                
                // 下载完成后清除选择
                this.clearSelection();
            }

            applyFilters() {
                this.currentPage = 1;
                this.loadOutputs();
            }

            resetFilters() {
                this.filters = {
                    workflow: '',
                    type: '',
                    timeRange: '',
                    search: '',
                    sort: 'created_at_desc'
                };
                
                document.getElementById('workflow-filter').value = '';
                document.getElementById('type-filter').value = '';
                document.getElementById('time-filter').value = '';
                document.getElementById('search-input').value = '';
                document.getElementById('sort-filter').value = 'created_at_desc';
                
                this.applyFilters();
            }

            updatePagination(totalItems) {
                const pagination = document.getElementById('pagination');
                const pageStart = document.getElementById('page-start');
                const pageEnd = document.getElementById('page-end');
                const totalItemsEl = document.getElementById('total-items');
                const pageInfo = document.getElementById('page-info');
                const prevBtn = document.getElementById('prev-page');
                const nextBtn = document.getElementById('next-page');
                
                if (totalItems === 0) {
                    pagination.classList.add('hidden');
                    return;
                }
                
                pagination.classList.remove('hidden');
                
                const start = (this.currentPage - 1) * this.pageSize + 1;
                const end = Math.min(this.currentPage * this.pageSize, totalItems);
                
                pageStart.textContent = start;
                pageEnd.textContent = end;
                totalItemsEl.textContent = totalItems;
                pageInfo.textContent = `第 ${this.currentPage} 页，共 ${this.totalPages} 页`;
                
                prevBtn.disabled = this.currentPage <= 1;
                nextBtn.disabled = this.currentPage >= this.totalPages;
            }

            showError(message) {
                alert(message);
            }
        }

        // 批量下载管理器类
        class BatchDownloadManager {
            constructor() {
                this.isOpen = false;
                this.downloads = new Map();
                this.totalFiles = 0;
                this.completedFiles = 0;
                this.totalSize = 0;
                this.downloadedSize = 0;
                this.startTime = null;
            }

            open() {
                this.isOpen = true;
                this.startTime = Date.now();
                document.getElementById('batch-download-sidebar').classList.add('active');
                document.getElementById('batch-download-overlay').classList.add('active');
                this.updateStats();
            }

            close() {
                this.isOpen = false;
                document.getElementById('batch-download-sidebar').classList.remove('active');
                document.getElementById('batch-download-overlay').classList.remove('active');
                
                // 清理未完成的下载
                this.downloads.forEach(download => {
                    if (download.status === 'downloading' && download.xhr) {
                        download.xhr.abort();
                    }
                });
                this.downloads.clear();
                document.getElementById('download-list').innerHTML = '';
            }

            addDownload(output) {
                const downloadId = Date.now() + Math.random();
                const download = {
                    id: downloadId,
                    output: output,
                    status: 'pending', // pending, downloading, completed, error, paused
                    progress: 0,
                    downloadedBytes: 0,
                    speed: 0,
                    xhr: null,
                    error: null
                };
                
                this.downloads.set(downloadId, download);
                this.totalSize += output.file_size || 0;
                this.renderDownloadItem(download);
                this.updateStats();
                
                return downloadId;
            }

            async startDownload(downloadId) {
                const download = this.downloads.get(downloadId);
                if (!download || download.status !== 'pending') return;
                
                download.status = 'downloading';
                
                try {
                    const xhr = new XMLHttpRequest();
                    download.xhr = xhr;
                    
                    xhr.open('GET', `/download/${encodeURIComponent(download.output.file_path)}`, true);
                    xhr.responseType = 'blob';
                    
                    const startTime = Date.now();
                    
                    xhr.onprogress = (event) => {
                        if (event.lengthComputable) {
                            download.progress = (event.loaded / event.total) * 100;
                            download.downloadedBytes = event.loaded;
                            
                            const elapsed = (Date.now() - startTime) / 1000;
                            download.speed = elapsed > 0 ? event.loaded / elapsed : 0;
                            
                            this.updateDownloadProgress(downloadId);
                            this.updateStats();
                        }
                    };
                    
                    xhr.onload = () => {
                        if (xhr.status === 200) {
                            download.status = 'completed';
                            download.progress = 100;
                            this.completedFiles++;
                            
                            // 自动下载文件
                            const blob = xhr.response;
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = download.output.filename;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            
                        } else {
                            download.status = 'error';
                            download.error = `HTTP ${xhr.status}`;
                        }
                        
                        this.updateDownloadProgress(downloadId);
                        this.updateStats();
                        
                        // 检查是否全部完成
                        if (this.completedFiles === this.totalFiles) {
                            this.showCompletionMessage();
                        }
                    };
                    
                    xhr.onerror = () => {
                        download.status = 'error';
                        download.error = '网络错误';
                        this.updateDownloadProgress(downloadId);
                        this.updateStats();
                    };
                    
                    xhr.send();
                    
                } catch (error) {
                    download.status = 'error';
                    download.error = error.message;
                    this.updateDownloadProgress(downloadId);
                    this.updateStats();
                }
            }

            pauseDownload(downloadId) {
                const download = this.downloads.get(downloadId);
                if (download && download.status === 'downloading' && download.xhr) {
                    download.xhr.abort();
                    download.status = 'paused';
                    this.updateDownloadProgress(downloadId);
                }
            }

            cancelDownload(downloadId) {
                const download = this.downloads.get(downloadId);
                if (download) {
                    if (download.xhr) {
                        download.xhr.abort();
                    }
                    this.downloads.delete(downloadId);
                    document.getElementById(`download-item-${downloadId}`).remove();
                    this.updateStats();
                }
            }

            renderDownloadItem(download) {
                const container = document.getElementById('download-list');
                const item = document.createElement('div');
                item.id = `download-item-${download.id}`;
                item.className = 'download-item';
                item.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2 flex-1 min-w-0">
                            <i class="${outputsManager.getFileIcon(outputsManager.getFileType(download.output.filename))} text-gray-500"></i>
                            <span class="text-sm font-medium text-gray-900 truncate" title="${download.output.filename}">
                                ${download.output.filename}
                            </span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <button onclick="batchDownloadManager.pauseDownload(${download.id})" class="btn-pause" title="暂停">
                                <i class="fas fa-pause text-xs"></i>
                            </button>
                            <button onclick="batchDownloadManager.cancelDownload(${download.id})" class="btn-cancel" title="取消">
                                <i class="fas fa-times text-xs"></i>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span class="download-status">等待中...</span>
                            <span class="download-speed">--</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            }

            updateDownloadProgress(downloadId) {
                const download = this.downloads.get(downloadId);
                if (!download) return;
                
                const item = document.getElementById(`download-item-${download.id}`);
                if (!item) return;
                
                const statusEl = item.querySelector('.download-status');
                const speedEl = item.querySelector('.download-speed');
                const progressFill = item.querySelector('.progress-fill');
                
                switch (download.status) {
                    case 'pending':
                        statusEl.textContent = '等待中...';
                        statusEl.className = 'download-status text-gray-500';
                        break;
                    case 'downloading':
                        statusEl.textContent = `下载中... ${download.progress.toFixed(1)}%`;
                        statusEl.className = 'download-status text-blue-600';
                        speedEl.textContent = this.formatSpeed(download.speed);
                        break;
                    case 'completed':
                        statusEl.textContent = '已完成';
                        statusEl.className = 'download-status text-green-600';
                        speedEl.textContent = '--';
                        break;
                    case 'error':
                        statusEl.textContent = `错误: ${download.error}`;
                        statusEl.className = 'download-status text-red-600';
                        speedEl.textContent = '--';
                        break;
                    case 'paused':
                        statusEl.textContent = '已暂停';
                        statusEl.className = 'download-status text-yellow-600';
                        speedEl.textContent = '--';
                        break;
                }
                
                progressFill.style.width = `${download.progress}%`;
            }

            updateStats() {
                const totalProgress = this.totalFiles > 0 ? (this.completedFiles / this.totalFiles) * 100 : 0;
                const elapsedTime = this.startTime ? (Date.now() - this.startTime) / 1000 : 0;
                
                // 计算总下载速度
                let totalSpeed = 0;
                this.downloads.forEach(download => {
                    if (download.status === 'downloading') {
                        totalSpeed += download.speed;
                    }
                });
                
                document.getElementById('download-progress').textContent = `${this.completedFiles}/${this.totalFiles}`;
                document.getElementById('download-speed').textContent = this.formatSpeed(totalSpeed);
                document.getElementById('overall-progress-fill').style.width = `${totalProgress}%`;
                document.getElementById('overall-progress-text').textContent = `${totalProgress.toFixed(1)}%`;
            }

            formatSpeed(bytesPerSecond) {
                if (bytesPerSecond < 1024) return `${bytesPerSecond.toFixed(0)} B/s`;
                if (bytesPerSecond < 1024 * 1024) return `${(bytesPerSecond / 1024).toFixed(1)} KB/s`;
                return `${(bytesPerSecond / (1024 * 1024)).toFixed(1)} MB/s`;
            }

            showCompletionMessage() {
                const elapsedTime = (Date.now() - this.startTime) / 1000;
                alert(`批量下载完成！\n共下载 ${this.completedFiles} 个文件\n用时 ${elapsedTime.toFixed(1)} 秒`);
            }

            pauseAll() {
                this.downloads.forEach((download, id) => {
                    if (download.status === 'downloading') {
                        this.pauseDownload(id);
                    }
                });
            }

            cancelAll() {
                const downloadIds = Array.from(this.downloads.keys());
                downloadIds.forEach(id => this.cancelDownload(id));
                this.close();
            }
        }

        // 全局视频播放管理器
        class VideoPlayerManager {
            constructor() {
                this.currentVideo = null;
                this.currentCard = null;
                this.originalContent = null;
            }

            playVideo(cardElement, videoPath, filename) {
                // 如果有正在播放的视频，先停止它
                this.stopCurrentVideo();
                
                // 找到预览区域
                const previewArea = cardElement.closest('.relative').querySelector('.relative.cursor-pointer');
                if (!previewArea) return;
                
                // 保存原始内容
                this.originalContent = previewArea.innerHTML;
                this.currentCard = cardElement.closest('.bg-white');
                
                // 创建视频播放器
                const videoPlayer = document.createElement('div');
                videoPlayer.className = 'h-48 bg-black rounded-t-lg relative overflow-hidden';
                videoPlayer.innerHTML = `
                    <video class="w-full h-full object-contain" controls autoplay>
                        <source src="${videoPath}" type="video/mp4">
                        您的浏览器不支持视频播放。
                    </video>
                    <button onclick="videoPlayerManager.stopVideo()" 
                            class="absolute top-2 right-2 bg-black bg-opacity-60 text-white p-2 rounded-full hover:bg-opacity-80 transition-opacity"
                            title="关闭播放器">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="absolute bottom-2 left-2 bg-black bg-opacity-60 text-white px-2 py-1 rounded text-xs">
                        ${filename}
                    </div>
                `;
                
                // 替换预览内容
                previewArea.innerHTML = '';
                previewArea.appendChild(videoPlayer);
                
                // 获取视频元素并设置事件监听
                this.currentVideo = videoPlayer.querySelector('video');
                this.currentVideo.addEventListener('ended', () => {
                    this.stopVideo();
                });
                
                // 添加键盘事件监听
                this.addKeyboardListeners();
            }

            stopVideo() {
                if (this.currentVideo) {
                    this.currentVideo.pause();
                    this.currentVideo = null;
                }
                
                if (this.currentCard && this.originalContent) {
                    const previewArea = this.currentCard.querySelector('.relative.cursor-pointer') || 
                                       this.currentCard.querySelector('.h-48');
                    if (previewArea) {
                        previewArea.outerHTML = this.originalContent;
                    }
                }
                
                this.currentCard = null;
                this.originalContent = null;
                this.removeKeyboardListeners();
            }

            stopCurrentVideo() {
                if (this.currentVideo) {
                    this.stopVideo();
                }
            }

            addKeyboardListeners() {
                document.addEventListener('keydown', this.handleKeyPress);
            }

            removeKeyboardListeners() {
                document.removeEventListener('keydown', this.handleKeyPress);
            }

            handleKeyPress = (event) => {
                if (!this.currentVideo) return;
                
                switch (event.code) {
                    case 'Space':
                        event.preventDefault();
                        if (this.currentVideo.paused) {
                            this.currentVideo.play();
                        } else {
                            this.currentVideo.pause();
                        }
                        break;
                    case 'Escape':
                        event.preventDefault();
                        this.stopVideo();
                        break;
                    case 'ArrowLeft':
                        event.preventDefault();
                        this.currentVideo.currentTime = Math.max(0, this.currentVideo.currentTime - 10);
                        break;
                    case 'ArrowRight':
                        event.preventDefault();
                        this.currentVideo.currentTime = Math.min(this.currentVideo.duration, this.currentVideo.currentTime + 10);
                        break;
                }
            }
        }

        // 全局函数
        function previewFile(filePath, filename, fileType) {
            currentPreviewFile = { filePath, filename, fileType };
            
            const modal = document.getElementById('preview-modal');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');
            
            title.textContent = filename;
            
            switch (fileType) {
                case 'image':
                    content.innerHTML = `<img src="${filePath}" alt="${filename}" class="max-w-full max-h-full object-contain">`;
                    break;
                case 'video':
                    content.innerHTML = `<video controls class="max-w-full max-h-full"><source src="${filePath}" type="video/mp4"></video>`;
                    break;
                case 'audio':
                    content.innerHTML = `<audio controls class="w-full"><source src="${filePath}" type="audio/mpeg"></audio>`;
                    break;
                case 'text':
                    fetch(filePath)
                        .then(response => response.text())
                        .then(text => {
                            content.innerHTML = `<pre class="whitespace-pre-wrap text-sm">${text}</pre>`;
                        })
                        .catch(error => {
                            content.innerHTML = `<p class="text-red-600">无法加载文件内容: ${error.message}</p>`;
                        });
                    break;
                default:
                    content.innerHTML = `<p class="text-gray-600">此文件类型不支持预览</p>`;
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function playVideoInCard(buttonElement, videoPath, filename) {
            videoPlayerManager.playVideo(buttonElement, videoPath, filename);
        }

        function playAudioInCard(buttonElement, audioPath, filename) {
            // 音频播放功能 - 可以后续扩展
            alert('音频播放功能开发中...');
        }

        function editTextFile(filePath, filename) {
            // 文本编辑功能 - 可以后续扩展
            alert('文本编辑功能开发中...');
        }

        function shareFile(filePath, filename) {
            // 分享功能 - 可以后续扩展
            if (navigator.share) {
                navigator.share({
                    title: filename,
                    url: filePath
                }).catch(console.error);
            } else {
                // 复制链接到剪贴板
                navigator.clipboard.writeText(window.location.origin + filePath)
                    .then(() => alert('文件链接已复制到剪贴板'))
                    .catch(() => alert('无法复制链接'));
            }
        }

        function closePreviewModal() {
            const modal = document.getElementById('preview-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            currentPreviewFile = null;
        }

        function downloadFile(filePath, filename) {
            const a = document.createElement('a');
            a.href = `/download/${encodeURIComponent(filePath)}`;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function downloadCurrentFile() {
            if (currentPreviewFile) {
                downloadFile(currentPreviewFile.filePath, currentPreviewFile.filename);
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', async () => {
            outputsManager = new OutputsManager();
            batchDownloadManager = new BatchDownloadManager();
            videoPlayerManager = new VideoPlayerManager();
            
            await outputsManager.init();
        });
    </script>
</body>
</html>