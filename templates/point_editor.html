{% extends 'base.html' %}
{% block page_title %}点集编辑器{% endblock %}
{% block content %}
<div class="grid grid-cols-12 gap-6">
  <!-- 左侧：画布与工具栏 -->
  <div class="col-span-12 lg:col-span-9 space-y-4">
    <div class="bg-white rounded-xl shadow p-4">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center space-x-2">
          <button id="tool-positive" class="px-3 py-2 rounded bg-green-500 text-white hover:bg-green-600" title="正样本 (P)">正样本</button>
          <button id="tool-negative" class="px-3 py-2 rounded bg-red-500 text-white hover:bg-red-600" title="负样本 (N)">负样本</button>
          <button id="tool-move" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300" title="平移 (Space/中键)">平移</button>
          <button id="tool-zoomfit" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300" title="适配窗口 (F)">适配</button>
          <button id="tool-clear" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300" title="清空 (Shift+Delete)">清空</button>
        </div>
        <div class="flex items-center space-x-2">
          <button id="tool-undo" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300" title="撤销 (Cmd/Ctrl+Z)"><i class="fas fa-undo"></i></button>
          <button id="tool-redo" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300" title="重做 (Cmd/Ctrl+Shift+Z)"><i class="fas fa-redo"></i></button>
          <button id="tool-load-image" class="px-3 py-2 rounded bg-primary text-white hover:bg-blue-600" title="选择图片 (JPG/PNG)">选择图片</button>
          <input id="image-file" type="file" accept="image/png,image/jpeg" class="hidden" />
          <button id="tool-export" class="px-3 py-2 rounded bg-blue-500 text-white hover:bg-blue-600" title="导出 (E)">导出</button>
          <input id="file-import" type="file" accept="application/json" class="hidden" />
          <button id="tool-import" class="px-3 py-2 rounded bg-blue-100 text-blue-700 hover:bg-blue-200" title="导入 (I)">导入</button>
          <button id="tool-paste-coords" class="px-3 py-2 rounded bg-green-100 text-green-700 hover:bg-green-200" title="粘贴坐标数据">粘贴坐标</button>
          <button id="tool-debug" class="px-3 py-2 rounded bg-gray-500 text-white hover:bg-gray-600" title="调试信息">调试</button>
          <button id="tool-load-video" class="px-3 py-2 rounded bg-blue-500 text-white hover:bg-blue-600" title="选择视频并截取首帧">
            <i class="fas fa-video mr-1"></i>选择视频
          </button>
          <input id="fileVideo" type="file" accept="video/*" class="hidden" />
          <button id="tool-save" class="px-3 py-2 rounded bg-green-500 text-white hover:bg-green-600 hidden" title="保存并返回">
            <i class="fas fa-save mr-1"></i>保存
          </button>
        </div>
      </div>
      <div id="canvas-container" class="relative border rounded-lg overflow-hidden bg-gray-100" style="height: 70vh; min-height: 420px;">
        <canvas id="point-canvas" class="w-full h-full block"></canvas>
      </div>
      <p class="text-xs text-gray-500 mt-2">提示：选择或拖拽 JPG/PNG 图片到上方区域进行加载；左键添加点，拖拽移动；删除：选中后按 Delete；缩放：滚轮；平移：按住空格或中键拖拽；触摸：双指缩放，单指拖拽；导入/导出为与 ComfyUI 兼容的像素坐标（保留高精度小数）。</p>
    </div>
  </div>

  <!-- 右侧：数据与属性 -->
  <div class="col-span-12 lg:col-span-3 space-y-4">
    <div class="bg-white rounded-xl shadow p-4">
      <h3 class="font-semibold text-gray-800 mb-2">当前图片</h3>
      <div class="text-sm text-gray-600 space-y-1">
        <div>分辨率：<span id="meta-size">-</span></div>
        <div>缩放：<span id="meta-zoom">100%</span></div>
        <div>视图原点：<span id="meta-origin">(0, 0)</span></div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow p-4">
      <h3 class="font-semibold text-gray-800 mb-2">视频分辨率设置</h3>
      <div class="text-sm text-gray-600 space-y-2">
        <div class="flex items-center space-x-2">
          <label class="w-12">宽度:</label>
          <input id="target-width" type="number" class="flex-1 px-2 py-1 border rounded text-sm" placeholder="528" value="528">
        </div>
        <div class="flex items-center space-x-2">
          <label class="w-12">高度:</label>
          <input id="target-height" type="number" class="flex-1 px-2 py-1 border rounded text-sm" placeholder="941" value="941">
        </div>
        <div class="flex items-center space-x-2">
          <label class="flex items-center text-xs">
            <input id="enable-resolution-fix" type="checkbox" checked class="mr-1">
            启用分辨率转换
          </label>
        </div>
        <p class="text-xs text-gray-500">视频首帧将强制转换为指定分辨率，确保与手动截图坐标一致</p>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow p-4">
      <h3 class="font-semibold text-gray-800 mb-2">点数据</h3>
      <textarea id="json-output" class="w-full h-48 border rounded p-2 text-xs font-mono" readonly></textarea>
      <div class="mt-2 flex items-center space-x-2">
        <button id="btn-copy" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm">复制</button>
        <label class="text-sm text-gray-500"><input id="normalize-toggle" type="checkbox" class="mr-1">导出为归一化坐标 [0,1]</label>
      </div>
    </div>
  </div>
</div>

<!-- 粘贴坐标模态框 -->
<div id="paste-coords-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
  <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
    <h3 class="text-lg font-semibold mb-4">粘贴坐标数据</h3>
    <p class="text-sm text-gray-600 mb-3">请粘贴ComfyUI点编辑器节点的坐标数据（JSON格式）：</p>
    <textarea id="coords-input" class="w-full h-32 border rounded p-3 text-sm font-mono" placeholder='{"positive":[{"x":346.06,"y":297.49}],"negative":[{"x":220.08,"y":355.17}]}'></textarea>
    
    <!-- 坐标类型选择 -->
    <div class="mt-3 mb-3">
      <label class="text-sm font-medium text-gray-700 mb-2 block">坐标类型：</label>
      <div class="space-y-1">
        <label class="flex items-center text-sm">
          <input type="radio" name="coord-type" value="auto" checked class="mr-2"> 自动检测
        </label>
        <label class="flex items-center text-sm">
          <input type="radio" name="coord-type" value="pixel" class="mr-2"> 像素坐标
        </label>
        <label class="flex items-center text-sm">
          <input type="radio" name="coord-type" value="normalized" class="mr-2"> 归一化坐标
        </label>
      </div>
    </div>
    
    <!-- ComfyUI兼容性修复选项 -->
    <div class="mt-3 mb-3 p-3 bg-blue-50 rounded border border-blue-200">
      <label class="flex items-center text-sm">
        <input type="checkbox" id="enable-coordinate-fix" checked class="mr-2"> 
        <span class="font-medium text-blue-800">启用ComfyUI坐标兼容性修复</span>
      </label>
      <p class="text-xs text-blue-600 mt-1">自动检测并修复ComfyUI坐标与当前项目的差异，提高坐标导入的准确性</p>
    </div>
    
    <div class="flex justify-end space-x-3 mt-4">
      <button id="cancel-paste" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">取消</button>
      <button id="confirm-paste" class="px-4 py-2 rounded bg-green-500 text-white hover:bg-green-600">导入</button>
    </div>
  </div>
</div>

<!-- 坐标调试面板 -->
<div id="debug-panel" class="fixed bottom-4 right-4 bg-white rounded-lg shadow-lg border max-w-sm w-full z-40 hidden">
  <div class="flex items-center justify-between p-3 border-b">
    <h4 class="font-semibold text-gray-800">坐标调试信息</h4>
    <button id="toggle-debug" class="text-sm px-2 py-1 rounded bg-gray-200 hover:bg-gray-300">隐藏</button>
  </div>
  <div class="p-3 space-y-3">
    <div>
      <h5 class="text-sm font-medium text-gray-700 mb-1">图片信息</h5>
      <div class="text-xs text-gray-600 space-y-1">
        <div>尺寸: <span id="debug-image-size">未加载</span></div>
        <div>缩放: <span id="debug-image-scale">1.0</span></div>
      </div>
    </div>
    <div>
      <h5 class="text-sm font-medium text-gray-700 mb-1">坐标列表</h5>
      <div id="debug-coords-list" class="text-xs text-gray-600 max-h-32 overflow-y-auto">
        <div class="text-gray-400">暂无坐标点</div>
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/coordinate_debug.js') }}"></script>
<script src="{{ url_for('static', filename='js/coordinate_test.js') }}"></script>
<script src="{{ url_for('static', filename='js/coordinate_fix.js') }}"></script>
<script src="{{ url_for('static', filename='js/video_frame_fix.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/point_editor.js') }}"></script>
{% endblock %}