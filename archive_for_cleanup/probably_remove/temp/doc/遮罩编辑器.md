# MaskEditor 单页网页 PRD（V1 轻量版，与项目集成）

> 目标：提供与项目架构统一的极简遮罩编辑器，仅实现「画、擦、保存、取消」四项核心能力；输出与原图像素对齐的灰度 PNG；优先复用现有项目结构与前端样式，避免过度开发。

---

## 1. 背景与范围

- 与 ComfyUI 的遮罩编辑体验等效，在 Web 端提供最小可用编辑器。
- 输出遮罩 PNG（与原图同尺寸，单通道/灰度）供下游流程消费。
- 轻量化实施：不新增后端 API；前端本地运行即可。

### 非目标（V1 不做）

- 魔棒、羽化、套索等复杂选择；
- 多图层/历史面板、Undo/Redo；
- 画布平移/缩放；
- 遮罩导入（V1 仅生成新遮罩）。

---

## 2. 架构与复用

- 页面与脚本位置：
  - `templates/mask_editor.html`（页面模板）
  - `static/js/mask_editor.js`（交互脚本）
- 样式与UI统一：沿用现有模板的按钮/布局风格（与 `templates/tasks.html`、`templates/task_management.html` 保持一致的间距与色板）。
- 事件模型：统一使用 `pointer` 事件，参考现有前端文件的组织方式（如 `static/js/main.js`、`static/js/point_editor.js` 的事件绑定和工具栏结构习惯）。
- 不引入构建工具；直接由 Flask 静态资源托管。

---

## 3. 用户流程（黄金路径）

1. 进入遮罩编辑页面 → 点击「选择图片」上传本地图片；或点击「选择视频」上传本地视频。
2. 若选择图片：页面显示原图；若选择视频：自动提取视频的第一帧作为底图显示。两种情况下都会叠加半透明红色遮罩层（初始为空）。
3. 工具栏：选择「画」或「擦」，调节画笔半径后在图上涂抹/擦除。
4. 点击「保存」→ 生成与底图同尺寸的灰度 PNG 并下载为 `mask.png`。
5. 点击「取消」→ 清空遮罩并回到初始状态。

---

## 4. 功能需求（FRD）

### FR-1 图片加载
- 支持本地上传（`<input type="file" accept="image/*">`）。
- 读取 `naturalWidth/naturalHeight`，将底图与遮罩两个 Canvas 的尺寸设为原图尺寸。
- 页面展示可按容器缩放，但所有交互坐标需映射到原尺寸（保证像素对齐）。

### FR-1b 视频加载与首帧提取
- 支持本地上传（`<input type="file" accept="video/*">`）。
- 读取 `video.videoWidth/video.videoHeight`，将底图与遮罩两个 Canvas 的尺寸设为视频尺寸。
- 自动提取首帧作为底图：在 `loadedmetadata` 后将 `currentTime=0`，等待 `seeked/loadeddata` 事件到达后在底图 Canvas 上绘制。
- 触摸与鼠标绘制逻辑与图片一致，坐标映射使用对应的 Canvas 尺寸。

### FR-2 涂抹与擦除
- 鼠标/触摸按下开始绘制，移动持续绘制，松开结束。
- 画笔半径范围：2~200 px（默认 20）。
- 模式：画（加红）/ 擦（去红）。
- 绘制算法：在遮罩 Canvas 上盖章圆形；移动时在前后点之间做线性插值，避免断点。

### FR-3 预览叠加
- 遮罩使用红色半透明（RGB=255,0,0，Alpha≈0.6），叠加在底图之上、随页面缩放显示。

### FR-4 保存
- 导出尺寸=原图尺寸；
- 遮罩叠加层转换为灰度：灰度=`max(R,G,B)`，`Alpha=255`；
- 自动下载文件名 `mask.png`。

### FR-5 取消
- 清空遮罩画布；恢复初始状态。

### FR-6 兼容性
- 桌面 Chrome/Edge/Firefox 最新版；
- 触摸设备支持（单指绘制）。

---

## 5. 非功能需求（NFR）

- 性能：1920×1080 图片下绘制无明显卡顿（目标 < 16ms/帧）。
- 对齐：导出遮罩与原图逐像素对齐。
- 健壮：全部在本地浏览器完成，避免外部依赖/CORS。

---

## 6. 交互与 UI 规范（与项目统一）

- 工具栏包含：
  - 「选择图片」按钮；
  - 「选择视频」按钮；
  - 模式切换（画/擦）；
  - 半径滑杆（2~200，默认20）；
  - 「保存」「取消」按钮；
- 画布区：
  - 背景 Canvas 显示原图；前景 Canvas 显示遮罩。
- 统一样式：采用项目现有的按钮与间距规范（Tailwind 类或等效样式），避免自定义色板偏离现有页面。

---

## 7. 坐标映射与数据结构

- Canvas 实际像素（`canvas.width/height`）始终等于原图尺寸。
- CSS 层面的缩放仅用于适配容器宽度，不影响绘制坐标。
- 坐标映射：

```js
const rect = canvas.getBoundingClientRect();
const scaleX = canvas.width / rect.width;
const scaleY = canvas.height / rect.height;
const x = (clientX - rect.left) * scaleX;
const y = (clientY - rect.top) * scaleY;
```

---

## 8. 导出规则

- 从遮罩 Canvas 读取 `ImageData`；将 RGB→灰度（`max(R,G,B)`），Alpha 固定为 255；
- 写回并 `toBlob('image/png')` 触发下载。

---

## 9. 边界与容错

- 未选择图片：除「选择图片」外禁用其他工具栏控件。
- 未选择视频：除「选择视频」外禁用其他控件；选中视频后流程与图片一致。
- 超大图片（>8K）：依然工作在原尺寸，可能内存吃紧；在 README 中提示注意事项。
- 视频跨域：使用 `URL.createObjectURL(file)` 加载本地视频，不涉及跨域；若未来支持网络视频需考虑 CORS 与 `crossOrigin` 设置。
- 视频解码差异：不同浏览器对 `seeked/loadeddata` 的触发时机可能不同，同时监听二者以提高兼容性；必要时可 `play()` 立即 `pause()` 以触发解码。
- 统一事件：使用 `pointer` 事件，避免不同设备差异。

---

## 10. 验收标准（UAT）

- 上传固定测试图（如 1024×768），圈选后保存 `mask.png`。
- 校验：遮罩 PNG 尺寸应等于原图；涂抹区域灰度值应接近白（>200），未涂抹区域接近黑（≈0）。

- 上传固定测试视频（如 1920×1080，首帧有明显标识），自动提取首帧并可进行涂抹后保存 `mask.png`。
- 校验：遮罩 PNG 尺寸应等于视频尺寸；涂抹区域灰度值应接近白（>200），未涂抹区域接近黑（≈0）。

---

## 11. 交付物与落地方式

- 项目内集成版：
  - `templates/mask_editor.html`（页面模板）
  - `static/js/mask_editor.js`（交互脚本）
- 运行方式：无需新增后端接口；通过 Flask 静态资源直接访问页面即可。
- 单文件便捷版（可选）：保留一个 `mask-editor.html` 纯前端单页用于快速验证（与集成版逻辑一致）。

---

## 12. 未来扩展（不在本次范围，仅预留）

- 若需对接后端：将下载改为 `POST /api/mask` 上传文件（复用 `app/api/outputs.py` 中的输出处理机制或新增轻量端点）。
- 若需工作流集成：在任务创建页或详情页提供入口跳转到遮罩编辑器（保持前端路由与模板一致）。

---

## 备注

- 本 PRD 遵循轻量化原则：仅实现目标能力，避免扩展功能。
- 样式与结构统一到现有模板体系，降低维护成本并提升一致性。
