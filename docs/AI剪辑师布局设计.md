# AI剪辑师布局设计（auto-editor）——更新版

## 背景与目标
- 页面采用上下布局：上半区为输入与运行控件，下半区为输出展示。
- 输出区包含两块：
  - AI 回复原文（可编辑 JSON，支持复制、折叠/展开）。
  - 结构化表格（固定表头、可内联编辑）。
- 移除使用量模块，避免界面冗余。
- 简化交互，不提供新增/删除/拖拽排序；只支持文本编辑与保存。

## 新增需求与变更点
- 原文 JSON 可编辑：用户可直接在“原文”区域编辑模型返回的 JSON 文本。
- 点击“确认更新表格”后，底部结构化表格将根据新原文自动重新解析并更新内容。
- 时间字段统一格式为 `mm:ss`；在解析 JSON 或更新表格时进行规范化。
- 原文块新增“复制全文”按钮。
- 保存成功提示使用状态栏文本，无需 Toast。
- 暂不支持导出 CSV/JSON（本期不做）。

## 需求复述
1. 上半区（输入控件）：
   - 提示词输入框。
   - 选择文件（图片内联；视频上传到后端并显示进度）。
   - 选择模型与输出格式（`markdown` / `json-table`）。
   - 发送与停止按钮。
   - 运行状态与进度条（含子进度文案）。
   - 运行日志输出（可滚动）。
   - 移除使用量模块。
2. 下半区（输出展示）：
   - 原文块：显示并允许编辑模型返回的 JSON 原文；提供折叠/展开、复制全文、确认更新表格。
   - 结构化表格块：根据 `phase2_creation_and_delivery.videoProductionBlueprint` 渲染固定表头表格；单元格内联可编辑；提供保存表格、打开策划页按钮（当有蓝图时）。

## UI 草图（示意）
```
----------------------------------------------------------------------------------+
| 上半区：输入与运行控件                                                             |
| [模型▼] [格式▼] [发送] [停止]                                                     |
| 提示词：┌───────────────────────────────────────────────────────────────┐        |
|        │ 请输入提示词……                                               │        |
|        └───────────────────────────────────────────────────────────────┘        |
| 文件： [选择文件]  上传进度：[███████-----]  67%                                   |
| 状态： 等待模型响应…  主进度：[███████-----]  子进度：N 秒                         |
| 运行日志：┌─────────────────────────────────────────────────────────────┐        |
|           │ [12:01:05] 已发送请求…                                    │        |
|           │ [12:01:12] 收到响应…                                      │        |
|           └─────────────────────────────────────────────────────────────┘        |
----------------------------------------------------------------------------------+

----------------------------------------------------------------------------------+
| 下半区：输出展示                                                                 |
| ┌ 原文（可编辑 JSON） ───────────────────────────────────────────────┐ [折叠/展开] |
| │ {                                                                  │ [复制全文] |
| │   "phase2_creation_and_delivery": {                               │ [确认更新表格] |
| │     "videoProductionBlueprint": [ { … } ]                         │             |
| │   }                                                                │             |
| │ }                                                                  │             |
| └────────────────────────────────────────────────────────────────────┘             |
|
| ┌ 结构化表格 ────────────────────────────────────────────────────────┐ [保存表格] [打开策划页] |
| │ 序列编号 | 视频名称 | 视频内容 | 起始时间 | 截止时间 | 画面描述 | 口播文案 | 导演备注 | 操作 │ |
| │    1    | 片头     | 主题介绍 | 00:00   | 00:07   | …        | …       | …       |      │ |
| │    2    | 产品镜头 | 卖点A    | 00:07   | 00:15   | …        | …       | …       |      │ |
| └────────────────────────────────────────────────────────────────────┘                          |
----------------------------------------------------------------------------------+
```

## 设计原则
- 简洁与聚焦：减少不必要控件与复杂交互，强化阅读与轻编辑。
- 安全与稳健：渲染文本进行 HTML 转义；JSON 解析异常不破坏表格现状。
- 可读与可用：宽表支持横向滚动；行交替背景提升可读性；键盘可访问。
- 解耦：渲染与保存逻辑与 UI解耦，方便后续扩展。

## 信息架构
- 上半区：输入控件、文件上传、发送/停止、运行状态与进度、运行日志。
- 下半区：原文（可编辑 JSON，折叠/展开、复制、确认更新）、结构化表格（可编辑、保存、打开策划页）。

## UI 设计
- 上半区（控件）：
  - `textarea` 提示词、多文件选择器、模型与格式下拉、发送/停止按钮。
  - 状态文本、主进度条、子进度文案；运行日志为固定高度滚动列表。
- 下半区（原文卡片）：
  - 默认折叠；点击展开显示可编辑 JSON 文本区（等宽字体）。
  - 提供“复制全文”与“确认更新表格”按钮；复制到剪贴板，确认后解析 JSON 并更新下方表格。
- 下半区（表格卡片）：
  - 固定表头：`序列编号`、`视频名称`、`视频内容`、`起始时间`、`截止时间`、`画面描述`、`口播文案`、`导演备注`、`操作`（留空）。
  - 表体行交替背景；文本列允许换行；时间列宽度较窄；支持横向滚动。
  - 单元格使用 `contenteditable` 的容器实现内联编辑。

## 交互设计
- 原文编辑：
  - 用户展开原文卡片，在 JSON 文本区直接编辑。
  - 点击“确认更新表格”：
    - 解析 JSON，若成功：抽取 `phase2_creation_and_delivery.videoProductionBlueprint`；
    - 将蓝图数组映射到表格字段；对 `startTime` / `endTime` 进行 `mm:ss` 规范化；
    - 刷新表格 DOM；状态栏提示“表格已根据新原文更新”。
    - 若解析失败：保留现有表格不变；状态栏显示错误，并在运行日志记录详情。
- 表格编辑：
  - 单元格文本可直接修改；在保存时采集当前 DOM 值为最终数据源。
  - 不支持新增/删除/拖拽排序；维持原数据顺序。
- 保存表格：
  - 采集 DOM，构造 `ai_editor_segments` 数据；POST `/api/auto-editor/save-table`。
  - 成功/失败在状态栏与日志中提示（无 Toast）。
- 打开策划页：
  - 当存在蓝图时展示按钮；通过 `localStorage` 传递数据，打开 `/video-strategy?id=...`；
  - 策划页默认进入第二阶段；若缺失第一阶段数据则隐藏其标签。

## 时间字段规范化（mm:ss）
- 规范：所有时间统一显示为 `mm:ss`。
- 处理策略：
  - 若为纯秒或带小数（如 `12.3`），转换为 `mm:ss`（向下取整秒，保留两位分钟与两位秒）。
  - 若为 `m:s`、`mm:s` 等非标准写法，统一补零为 `mm:ss`。
  - 非法值保持原样并在日志提示（不阻塞保存）。
- 实现建议：
  - 提供前端工具函数 `normalizeTime(value)`，返回 `mm:ss` 字符串。
  - 在“确认更新表格”与“保存表格”两处均应用规范化。

## 数据结构与数据流
- 数据来源：模型返回的原文文本（优先 JSON）。
  - 若用户选择 `json-table` 且 JSON 中包含 Phase 2 蓝图，则渲染表格。
  - 原文文本始终可见并可编辑；是更新表格的“单一真源”。
- 字段映射（容错）：
  - `序列编号` → `sequenceNumber`
  - `视频名称` → `videoName`
  - `视频内容` → `videoContent`
  - `起始时间` → `startTime`（规范化 `mm:ss`）
  - `截止时间` → `endTime`（规范化 `mm:ss`）
  - `画面描述` → `sceneDescription`
  - `口播文案` → `voiceover`
  - `导演备注` → `directorNotes`
  - `操作` → 空
- 策划数据检测：仅需 `phase2_creation_and_delivery.videoProductionBlueprint` 为非空数组。
- 保存数据：POST `/api/auto-editor/save-table`，`tableName=ai_editor_segments`，`tableData` 为当前 DOM 采集数组。

## 状态与错误处理
- 状态栏：展示运行状态、进度、操作成功/失败提示（取代 Toast）。
- 错误：解析 JSON 失败、后端保存失败等，均在状态栏与日志提示；页面保持可继续编辑。
- 安全：对渲染文本进行 HTML 转义；原文以纯文本显示与编辑（不渲染 markdown）。

## 模块改动建议（参考）
- `templates/auto_editor.html`：调整上下布局；新增原文 JSON 编辑卡片与表格卡片；移除使用量模块。
- `static/js/auto_editor.js`：
  - 渲染原文与表格；实现“确认更新表格”→解析 JSON→映射蓝图→更新表格。
  - 提供 `normalizeTime`；在更新与保存时统一时间格式。
  - 采集 DOM 并保存至 `/api/auto-editor/save-table`；状态栏与日志提示。
  - 打开策划页联动（仅蓝图存在时显示按钮）。
- `templates/video_strategy.html` / `static/js/video_strategy.js`：默认显示第二阶段；缺失第一阶段数据则隐藏其标签。

## 验证与测试计划
- 纯文本返回（不含 JSON）：原文可编辑但确认更新时提示解析失败；表格不变。
- 含蓝图 JSON：确认更新后表格正确渲染；时间统一 `mm:ss`。
- 编辑后保存：状态栏提示成功；日志记录请求与响应。
- 大文本与长表格：滚动与性能正常，编辑体验流畅。
- 中文与特殊字符：正确 HTML 转义；复制与编辑不破坏结构。
- 打开策划页：数据传递正确，默认进入第二阶段。

## 无障碍与可用性
- 键盘操作：`Tab` 在控件、原文编辑区、表格单元格间顺序访问；`Esc` 可结束编辑。
- 视觉提示：编辑态单元格轻微高亮；错误状态在状态栏显式提示。

## 风险与权衡
- JSON 结构差异：字段名与层级可能不一致；通过映射与容错处理。
- 时间规范化：可能与用户期望格式不同；统一规则提升一致性。
- 性能：超大 JSON 或表格可能影响渲染；当前优化一般使用场景。

## 实施步骤（参考）
1. HTML 布局调整：上/下分区；新增原文编辑与表格容器；移除使用量模块。
2. JS 实现：原文渲染与编辑、确认更新表格逻辑、时间规范化函数、表格渲染与编辑。
3. 保存与联动：采集 DOM 保存；存在蓝图则开放“打开策划页”。
4. 状态与日志：统一状态栏提示与日志追加；错误不阻塞编辑。
5. 测试与验收：覆盖上述用例；检查窄屏与滚动体验。

## 已决事项
- 时间字段格式：统一为 `mm:ss`。
- 原文块复制：提供“复制全文”按钮。
- 成功提示形式：使用状态栏提示（不使用 Toast）。
- 导出功能：暂不支持 CSV/JSON（后续迭代再评估）。