<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‚¹ç¼–è¾‘å™¨å‚æ•°ä¼ é€’æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #fafafa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .button-group {
            margin: 15px 0;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        .output-area {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .comparison-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .old-mode {
            background-color: #ffe6e6;
        }
        .new-mode {
            background-color: #e6ffe6;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success {
            background-color: #28a745;
        }
        .status-warning {
            background-color: #ffc107;
        }
        .status-error {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª ç‚¹ç¼–è¾‘å™¨å‚æ•°ä¼ é€’æµ‹è¯•</h1>
            <p>éªŒè¯ä¼˜åŒ–åçš„å•å‚æ•°æ¨¡å¼ï¼ˆä»…ä¼ é€’points_storeï¼‰</p>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•æ•°æ®ç”Ÿæˆ</h3>
            <div class="button-group">
                <button class="btn btn-primary" onclick="generateTestData()">ç”Ÿæˆæµ‹è¯•æ•°æ®</button>
                <button class="btn btn-warning" onclick="clearTestData()">æ¸…ç©ºæ•°æ®</button>
            </div>
            <div id="testDataOutput" class="output-area">
                ç‚¹å‡»"ç”Ÿæˆæµ‹è¯•æ•°æ®"å¼€å§‹æµ‹è¯•...
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ”„ å‚æ•°ä¼ é€’æ¨¡å¼å¯¹æ¯”</h3>
            <div class="button-group">
                <button class="btn btn-primary" onclick="testOldMode()">æµ‹è¯•æ—§çš„3å‚æ•°æ¨¡å¼</button>
                <button class="btn btn-success" onclick="testNewMode()">æµ‹è¯•ä¼˜åŒ–åçš„å•å‚æ•°æ¨¡å¼</button>
                <button class="btn btn-warning" onclick="compareResults()">å¯¹æ¯”ç»“æœ</button>
            </div>
            <div id="comparisonOutput" class="output-area">
                é€‰æ‹©æµ‹è¯•æ¨¡å¼å¼€å§‹å¯¹æ¯”...
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ˆ æ€§èƒ½åˆ†æ</h3>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>æŒ‡æ ‡</th>
                        <th class="old-mode">æ—§æ¨¡å¼ï¼ˆ3å‚æ•°ï¼‰</th>
                        <th class="new-mode">æ–°æ¨¡å¼ï¼ˆå•å‚æ•°ï¼‰</th>
                        <th>æ”¹è¿›æ•ˆæœ</th>
                    </tr>
                </thead>
                <tbody id="performanceTable">
                    <tr>
                        <td>å‚æ•°æ•°é‡</td>
                        <td id="oldParamCount">-</td>
                        <td id="newParamCount">-</td>
                        <td id="paramCountImprovement">-</td>
                    </tr>
                    <tr>
                        <td>æ•°æ®å¤§å°</td>
                        <td id="oldDataSize">-</td>
                        <td id="newDataSize">-</td>
                        <td id="dataSizeImprovement">-</td>
                    </tr>
                    <tr>
                        <td>å†…å­˜é£é™©</td>
                        <td id="oldMemoryRisk">-</td>
                        <td id="newMemoryRisk">-</td>
                        <td id="memoryRiskImprovement">-</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="test-section">
            <h3>âœ… éªŒè¯ç»“æœ</h3>
            <div id="validationResults" class="output-area">
                è¿è¡Œæµ‹è¯•åæ˜¾ç¤ºéªŒè¯ç»“æœ...
            </div>
        </div>
    </div>

    <script>
        let testData = null;
        let oldModeResults = null;
        let newModeResults = null;

        function generateTestData() {
            testData = {
                coordinates: {
                    positive: [
                        {x: 346.06, y: 297.49},
                        {x: 400.12, y: 350.75},
                        {x: 280.33, y: 220.88},
                        {x: 520.45, y: 180.22},
                        {x: 150.67, y: 420.33}
                    ],
                    negative: [
                        {x: 220.08, y: 355.17},
                        {x: 150.45, y: 180.92},
                        {x: 600.78, y: 250.44}
                    ]
                }
            };

            const output = document.getElementById('testDataOutput');
            output.innerHTML = `
                <strong>âœ… æµ‹è¯•æ•°æ®å·²ç”Ÿæˆ</strong><br>
                æ­£æ ·æœ¬æ•°é‡: ${testData.coordinates.positive.length}<br>
                è´Ÿæ ·æœ¬æ•°é‡: ${testData.coordinates.negative.length}<br>
                <br>
                <strong>æ­£æ ·æœ¬åæ ‡:</strong><br>
                ${JSON.stringify(testData.coordinates.positive, null, 2)}<br>
                <br>
                <strong>è´Ÿæ ·æœ¬åæ ‡:</strong><br>
                ${JSON.stringify(testData.coordinates.negative, null, 2)}
            `;
        }

        function clearTestData() {
            testData = null;
            oldModeResults = null;
            newModeResults = null;
            
            document.getElementById('testDataOutput').innerHTML = 'æ•°æ®å·²æ¸…ç©ºï¼Œç‚¹å‡»"ç”Ÿæˆæµ‹è¯•æ•°æ®"é‡æ–°å¼€å§‹...';
            document.getElementById('comparisonOutput').innerHTML = 'é€‰æ‹©æµ‹è¯•æ¨¡å¼å¼€å§‹å¯¹æ¯”...';
            document.getElementById('validationResults').innerHTML = 'è¿è¡Œæµ‹è¯•åæ˜¾ç¤ºéªŒè¯ç»“æœ...';
            
            // æ¸…ç©ºæ€§èƒ½è¡¨æ ¼
            document.getElementById('oldParamCount').textContent = '-';
            document.getElementById('newParamCount').textContent = '-';
            document.getElementById('paramCountImprovement').textContent = '-';
            document.getElementById('oldDataSize').textContent = '-';
            document.getElementById('newDataSize').textContent = '-';
            document.getElementById('dataSizeImprovement').textContent = '-';
            document.getElementById('oldMemoryRisk').textContent = '-';
            document.getElementById('newMemoryRisk').textContent = '-';
            document.getElementById('memoryRiskImprovement').textContent = '-';
        }

        function testOldMode() {
            if (!testData) {
                alert('è¯·å…ˆç”Ÿæˆæµ‹è¯•æ•°æ®ï¼');
                return;
            }

            const positiveCoords = testData.coordinates.positive;
            const negativeCoords = testData.coordinates.negative;

            // æ„å»º3ä¸ªå‚æ•°ï¼ˆæ—§æ¨¡å¼ï¼‰
            const pointsStoreData = {
                positive: positiveCoords,
                negative: negativeCoords
            };

            oldModeResults = [
                {
                    nodeId: "38",
                    fieldName: "points_store",
                    fieldValue: JSON.stringify(pointsStoreData)
                },
                {
                    nodeId: "38",
                    fieldName: "coordinates",
                    fieldValue: JSON.stringify(positiveCoords)
                },
                {
                    nodeId: "38",
                    fieldName: "neg_coordinates",
                    fieldValue: JSON.stringify(negativeCoords)
                }
            ];

            const totalSize = oldModeResults.reduce((sum, node) => sum + node.fieldValue.length, 0);

            const output = document.getElementById('comparisonOutput');
            output.innerHTML = `
                <strong>ğŸ”´ æ—§çš„3å‚æ•°æ¨¡å¼æµ‹è¯•ç»“æœ:</strong><br>
                å‚æ•°æ•°é‡: ${oldModeResults.length}<br>
                æ­£æ ·æœ¬æ•°é‡: ${positiveCoords.length}<br>
                è´Ÿæ ·æœ¬æ•°é‡: ${negativeCoords.length}<br>
                æ€»æ•°æ®å¤§å°: ${totalSize} å­—ç¬¦<br>
                å†…å­˜ä½¿ç”¨: é«˜ï¼ˆåŒ…å«é‡å¤æ•°æ®ï¼‰<br>
                é£é™©: å¯èƒ½å¯¼è‡´torch.OutOfMemoryError<br>
                <br>
                <strong>å‚æ•°è¯¦æƒ…:</strong><br>
                ${oldModeResults.map(node => `${node.fieldName}: ${node.fieldValue.length} å­—ç¬¦`).join('<br>')}
            `;

            updatePerformanceTable();
        }

        function testNewMode() {
            if (!testData) {
                alert('è¯·å…ˆç”Ÿæˆæµ‹è¯•æ•°æ®ï¼');
                return;
            }

            const positiveCoords = testData.coordinates.positive;
            const negativeCoords = testData.coordinates.negative;

            // æ„å»ºå•ä¸ªå‚æ•°ï¼ˆæ–°æ¨¡å¼ï¼‰
            const pointsStoreData = {
                positive: positiveCoords,
                negative: negativeCoords
            };

            newModeResults = [
                {
                    nodeId: "38",
                    fieldName: "points_store",
                    fieldValue: JSON.stringify(pointsStoreData)
                }
            ];

            const totalSize = newModeResults.reduce((sum, node) => sum + node.fieldValue.length, 0);

            const output = document.getElementById('comparisonOutput');
            output.innerHTML = `
                <strong>ğŸŸ¢ ä¼˜åŒ–åçš„å•å‚æ•°æ¨¡å¼æµ‹è¯•ç»“æœ:</strong><br>
                å‚æ•°æ•°é‡: ${newModeResults.length}<br>
                æ­£æ ·æœ¬æ•°é‡: ${positiveCoords.length}<br>
                è´Ÿæ ·æœ¬æ•°é‡: ${negativeCoords.length}<br>
                æ€»æ•°æ®å¤§å°: ${totalSize} å­—ç¬¦<br>
                å†…å­˜ä½¿ç”¨: ä½ï¼ˆæ— é‡å¤æ•°æ®ï¼‰<br>
                é£é™©: é¿å…äº†torch.OutOfMemoryError<br>
                <br>
                <strong>å‚æ•°è¯¦æƒ…:</strong><br>
                ${newModeResults.map(node => `${node.fieldName}: ${node.fieldValue.length} å­—ç¬¦`).join('<br>')}
            `;

            updatePerformanceTable();
        }

        function compareResults() {
            if (!oldModeResults || !newModeResults) {
                alert('è¯·å…ˆè¿è¡Œä¸¤ç§æ¨¡å¼çš„æµ‹è¯•ï¼');
                return;
            }

            const oldSize = oldModeResults.reduce((sum, node) => sum + node.fieldValue.length, 0);
            const newSize = newModeResults.reduce((sum, node) => sum + node.fieldValue.length, 0);
            const reduction = oldSize - newSize;
            const reductionPercent = ((reduction / oldSize) * 100).toFixed(1);

            const output = document.getElementById('comparisonOutput');
            output.innerHTML = `
                <strong>ğŸ“Š å¯¹æ¯”åˆ†æç»“æœ:</strong><br>
                <br>
                <strong>å‚æ•°æ•°é‡å¯¹æ¯”:</strong><br>
                æ—§æ¨¡å¼: ${oldModeResults.length} ä¸ªå‚æ•°<br>
                æ–°æ¨¡å¼: ${newModeResults.length} ä¸ªå‚æ•°<br>
                å‡å°‘: ${oldModeResults.length - newModeResults.length} ä¸ªå‚æ•°<br>
                <br>
                <strong>æ•°æ®å¤§å°å¯¹æ¯”:</strong><br>
                æ—§æ¨¡å¼: ${oldSize} å­—ç¬¦<br>
                æ–°æ¨¡å¼: ${newSize} å­—ç¬¦<br>
                å‡å°‘: ${reduction} å­—ç¬¦ (${reductionPercent}%)<br>
                <br>
                <strong>ä¼˜åŒ–æ•ˆæœ:</strong><br>
                ${reduction > 0 ? 'âœ… å†…å­˜ä½¿ç”¨æ˜¾è‘—å‡å°‘' : 'âš ï¸ å†…å­˜ä½¿ç”¨æœªå‡å°‘'}<br>
                ${reductionPercent > 40 ? 'âœ… ä¼˜åŒ–æ•ˆæœæ˜¾è‘—' : 'âš ï¸ ä¼˜åŒ–æ•ˆæœä¸€èˆ¬'}<br>
                âœ… é¿å…äº†å‚æ•°å†—ä½™<br>
                âœ… é™ä½äº†torch.OutOfMemoryErroré£é™©
            `;

            validateResults();
        }

        function validateResults() {
            if (!newModeResults) {
                return;
            }

            const pointsStoreNode = newModeResults.find(node => node.fieldName === 'points_store');
            
            let validationHtml = '<strong>ğŸ” å‚æ•°å®Œæ•´æ€§éªŒè¯:</strong><br>';

            if (!pointsStoreNode) {
                validationHtml += '<span class="status-indicator status-error"></span>âŒ ç¼ºå°‘points_storeå‚æ•°<br>';
            } else {
                try {
                    const pointsData = JSON.parse(pointsStoreNode.fieldValue);
                    const positiveCount = pointsData.positive ? pointsData.positive.length : 0;
                    const negativeCount = pointsData.negative ? pointsData.negative.length : 0;

                    validationHtml += '<span class="status-indicator status-success"></span>âœ… points_storeå‚æ•°å­˜åœ¨<br>';
                    validationHtml += `<span class="status-indicator status-success"></span>âœ… åŒ…å«æ­£æ ·æœ¬: ${positiveCount}ä¸ª<br>`;
                    validationHtml += `<span class="status-indicator status-success"></span>âœ… åŒ…å«è´Ÿæ ·æœ¬: ${negativeCount}ä¸ª<br>`;
                    validationHtml += '<span class="status-indicator status-success"></span>âœ… æ•°æ®æ ¼å¼æ­£ç¡®<br>';

                    if (positiveCount > 0 || negativeCount > 0) {
                        validationHtml += '<span class="status-indicator status-success"></span>âœ… åæ ‡æ•°æ®æœ‰æ•ˆ<br>';
                    } else {
                        validationHtml += '<span class="status-indicator status-warning"></span>âš ï¸ åæ ‡æ•°æ®ä¸ºç©º<br>';
                    }

                    validationHtml += '<br><strong>ğŸ¯ æµ‹è¯•ç»“è®º:</strong><br>';
                    validationHtml += '<span class="status-indicator status-success"></span>âœ… ä¼˜åŒ–åçš„å•å‚æ•°æ¨¡å¼å·¥ä½œæ­£å¸¸<br>';
                    validationHtml += '<span class="status-indicator status-success"></span>âœ… å‚æ•°å®Œæ•´æ€§éªŒè¯é€šè¿‡<br>';
                    validationHtml += '<span class="status-indicator status-success"></span>âœ… å†…å­˜ä½¿ç”¨å¾—åˆ°ä¼˜åŒ–<br>';
                    validationHtml += '<span class="status-indicator status-success"></span>âœ… é¿å…äº†torch.OutOfMemoryErroré£é™©<br>';

                } catch (e) {
                    validationHtml += `<span class="status-indicator status-error"></span>âŒ æ•°æ®æ ¼å¼é”™è¯¯: ${e.message}<br>`;
                }
            }

            document.getElementById('validationResults').innerHTML = validationHtml;
        }

        function updatePerformanceTable() {
            if (oldModeResults) {
                const oldSize = oldModeResults.reduce((sum, node) => sum + node.fieldValue.length, 0);
                document.getElementById('oldParamCount').textContent = oldModeResults.length;
                document.getElementById('oldDataSize').textContent = oldSize + ' å­—ç¬¦';
                document.getElementById('oldMemoryRisk').textContent = 'é«˜é£é™©';
            }

            if (newModeResults) {
                const newSize = newModeResults.reduce((sum, node) => sum + node.fieldValue.length, 0);
                document.getElementById('newParamCount').textContent = newModeResults.length;
                document.getElementById('newDataSize').textContent = newSize + ' å­—ç¬¦';
                document.getElementById('newMemoryRisk').textContent = 'ä½é£é™©';
            }

            if (oldModeResults && newModeResults) {
                const oldSize = oldModeResults.reduce((sum, node) => sum + node.fieldValue.length, 0);
                const newSize = newModeResults.reduce((sum, node) => sum + node.fieldValue.length, 0);
                const paramReduction = oldModeResults.length - newModeResults.length;
                const sizeReduction = oldSize - newSize;
                const sizeReductionPercent = ((sizeReduction / oldSize) * 100).toFixed(1);

                document.getElementById('paramCountImprovement').textContent = `å‡å°‘ ${paramReduction} ä¸ª`;
                document.getElementById('dataSizeImprovement').textContent = `å‡å°‘ ${sizeReduction} å­—ç¬¦ (${sizeReductionPercent}%)`;
                document.getElementById('memoryRiskImprovement').textContent = 'æ˜¾è‘—é™ä½';
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•æ•°æ®
        window.onload = function() {
            generateTestData();
        };
    </script>
</body>
</html>